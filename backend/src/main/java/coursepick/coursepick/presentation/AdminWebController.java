package coursepick.coursepick.presentation;

import coursepick.coursepick.application.exception.ErrorType;
import coursepick.coursepick.domain.Coordinate;
import coursepick.coursepick.domain.Course;
import coursepick.coursepick.domain.CourseRepository;
import coursepick.coursepick.presentation.dto.AdminCourseWebResponse;
import coursepick.coursepick.presentation.dto.AdminLoginWebRequest;
import coursepick.coursepick.presentation.dto.CourseRelaceWebRequest;
import jakarta.validation.Valid;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.web.server.Cookie;
import org.springframework.context.annotation.Profile;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseCookie;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.time.Duration;
import java.util.List;

@RestController
@Profile("dev")
public class AdminWebController {

    private static final String TOKEN_COOKIE_KEY = "admin-token";
    private final String adminToken;
    private final String kakaoMapApiKey;

    private final CourseRepository courseRepository;

    public AdminWebController(
            @Value("${admin.token}") String adminToken,
            @Value("${admin.kakao-map-api-key}") String kakaoMapApiKey,
            CourseRepository courseRepository
    ) {
        this.adminToken = adminToken;
        this.kakaoMapApiKey = kakaoMapApiKey;
        this.courseRepository = courseRepository;
    }

    @GetMapping("/admin/login")
    public ResponseEntity<String> adminLoginPage() {
        return ResponseEntity.ok()
                .contentType(MediaType.TEXT_HTML)
                .body(ADMIN_LOGIN_PAGE);
    }

    @PostMapping("/admin/login")
    public ResponseEntity<Void> login(@RequestBody @Valid AdminLoginWebRequest request) {
        if (!adminToken.equals(request.password())) {
            throw ErrorType.INVALID_ADMIN_PASSWORD.create();
        }
        ResponseCookie tokenCookie = ResponseCookie.from(TOKEN_COOKIE_KEY, adminToken)
                .httpOnly(true)
                .maxAge(Duration.ofHours(1))
                .sameSite(Cookie.SameSite.STRICT.attributeValue())
                .path("/admin")
                .build();

        return ResponseEntity.ok()
                .header(HttpHeaders.SET_COOKIE, tokenCookie.toString())
                .build();
    }

    @GetMapping("/admin")
    public ResponseEntity<String> adminPage() {
        return ResponseEntity.ok()
                .contentType(MediaType.TEXT_HTML)
                .body(ADMIN_MAIN_PAGE.replace("KAKAO_API_KEY_PLACEHOLDER", kakaoMapApiKey));
    }

    @GetMapping("/admin/courses/{id}")
    public AdminCourseWebResponse findCourseById(@PathVariable("id") String id) {
        Course course = courseRepository.findById(id)
                .orElseThrow(ErrorType.NOT_EXIST_COURSE::create);

        return AdminCourseWebResponse.from(course);
    }

    @GetMapping("/admin/courses/edit")
    public ResponseEntity<String> courseEditPage() {
        return ResponseEntity.ok()
                .contentType(MediaType.TEXT_HTML)
                .body(ADMIN_EDIT_PAGE.replace("KAKAO_API_KEY_PLACEHOLDER", kakaoMapApiKey));
    }

    @PatchMapping("/admin/courses/{id}")
    public ResponseEntity<Void> modifyCourse(
            @PathVariable("id") String courseId,
            @RequestBody CourseRelaceWebRequest request
    ) {
        Course course = courseRepository.findById(courseId)
                .orElseThrow(ErrorType.NOT_EXIST_COURSE::create);
        List<List<Double>> rawCoordinates = request.coordinates();

        if (rawCoordinates != null && !rawCoordinates.isEmpty()) {
            List<Coordinate> coordinates = rawCoordinates.stream()
                    .map(rawCoordinate -> new Coordinate(rawCoordinate.get(0), rawCoordinate.get(1), rawCoordinate.get(2)))
                    .toList();
            course.changeCoordinates(coordinates);
        }
        if (request.name() != null) course.changeName(request.name());
        if (request.roadType() != null) course.changeRoadType(request.roadType());

        courseRepository.save(course);
        return ResponseEntity.ok().build();
    }

    @DeleteMapping("/admin/courses/{id}")
    public ResponseEntity<Void> deleteCourse(@PathVariable("id") String id) {
        Course course = courseRepository.findById(id)
                .orElseThrow(ErrorType.NOT_EXIST_COURSE::create);
        courseRepository.delete(course);

        return ResponseEntity.ok().build();
    }

    private static final String ADMIN_LOGIN_PAGE = """
            <!DOCTYPE html>
            <html lang="ko">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Îü∞ÏÑ∏Í∂å Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏</title>
                <style>
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
            }

            body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
              -webkit-font-smoothing: antialiased;
              -moz-osx-font-smoothing: grayscale;
            }

            .admin-login-page-container {
              display: flex;
              justify-content: center;
              align-items: center;
              min-height: 100vh;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              padding: 20px;
            }

            .admin-login-container {
              padding: 50px 40px;
              background: white;
              border-radius: 20px;
              box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
              width: 100%;
              max-width: 450px;
              text-align: center;
              animation: slideIn 0.5s ease-out;
            }

            @keyframes slideIn {
              from {
                opacity: 0;
                transform: translateY(-30px);
              }
              to {
                opacity: 1;
                transform: translateY(0);
              }
            }

            .admin-login-title {
              margin-bottom: 10px;
              color: #2d3748;
              font-size: 32px;
              font-weight: 700;
            }

            .admin-login-subtitle {
              margin-bottom: 30px;
              color: #718096;
              font-size: 14px;
            }

            .admin-login-form {
              display: flex;
              flex-direction: column;
              gap: 20px;
            }

            .admin-login-input {
              padding: 16px 20px;
              border-radius: 10px;
              border: 2px solid #e2e8f0;
              font-size: 16px;
              transition: all 0.3s ease;
              outline: none;
            }

            .admin-login-input:focus {
              border-color: #667eea;
              box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

            .admin-login-input::placeholder {
              color: #a0aec0;
            }

            .admin-login-button {
              padding: 16px;
              border: none;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              border-radius: 10px;
              cursor: pointer;
              font-size: 16px;
              font-weight: 600;
              transition: all 0.3s ease;
              box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            }

            .admin-login-button:hover {
              transform: translateY(-2px);
              box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
            }

            .admin-login-button:active {
              transform: translateY(0);
            }

            .admin-login-button:disabled {
              opacity: 0.6;
              cursor: not-allowed;
              transform: none;
            }

            .error-message {
              margin-top: 15px;
              padding: 12px;
              border-radius: 8px;
              background-color: #fed7d7;
              color: #c53030;
              font-size: 14px;
              display: none;
              animation: shake 0.5s ease;
            }

            .error-message.show {
              display: block;
            }

            @keyframes shake {
              0%, 100% { transform: translateX(0); }
              10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
              20%, 40%, 60%, 80% { transform: translateX(5px); }
            }

            @media (max-width: 480px) {
              .admin-login-container {
                padding: 40px 30px;
              }

              .admin-login-title {
                font-size: 28px;
              }
            }
                </style>
            </head>
            <body>
            <div class="admin-login-page-container">
                <div class="admin-login-container">
                    <h1 class="admin-login-title">üèÉ Îü∞ÏÑ∏Í∂å Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ</h1>
                    <p class="admin-login-subtitle">ÏïàÎÖïÌïòÏÑ∏Ïöî üëã</p>
                    <form class="admin-login-form" id="admin-login-form">
                        <input
                                type="password"
                                id="admin-password"
                                placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                                class="admin-login-input"
                                required
                                autocomplete="current-password">
                        <button type="submit" class="admin-login-button">Î°úÍ∑∏Ïù∏</button>
                    </form>
                    <div id="error-message" class="error-message"></div>
                </div>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
            <script>
            document.addEventListener('DOMContentLoaded', () => {
                const adminLoginForm = document.getElementById('admin-login-form');
                const passwordInput = document.getElementById('admin-password');
                const errorMessage = document.getElementById('error-message');
                const loginButton = adminLoginForm.querySelector('button[type="submit"]');

                const showError = (message) => {
                    errorMessage.textContent = message;
                    errorMessage.classList.add('show');
                    setTimeout(() => {
                        errorMessage.classList.remove('show');
                    }, 5000);
                };

                const hideError = () => {
                    errorMessage.classList.remove('show');
                };

                adminLoginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    hideError();

                    const password = passwordInput.value.trim();

                    if (!password) {
                        showError('ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                        return;
                    }

                    loginButton.disabled = true;
                    loginButton.textContent = 'Î°úÍ∑∏Ïù∏ Ï§ë...';

                    try {
                        const response = await axios.post('/admin/login', {
                            password: password
                        }, {
                            withCredentials: true
                        });

                        window.location.href = '/admin';
                    } catch (error) {
                        console.error('Admin login failed:', error);

                        if (error.response) {
                            const status = error.response.status;
                            if (status === 401) {
                                showError('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.');
                            } else if (status === 400) {
                                showError('ÏûòÎ™ªÎêú ÏöîÏ≤≠ÏûÖÎãàÎã§.');
                            } else {
                                showError('Î°úÍ∑∏Ïù∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                            }
                        } else if (error.request) {
                            showError('ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
                        } else {
                            showError('Î°úÍ∑∏Ïù∏ Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
                        }

                        passwordInput.value = '';
                        passwordInput.focus();
                    } finally {
                        loginButton.disabled = false;
                        loginButton.textContent = 'Î°úÍ∑∏Ïù∏';
                    }
                });

                passwordInput.addEventListener('input', () => {
                    hideError();
                });

                passwordInput.focus();
            });
            </script>
            </body>
            </html>
            """;

    private static final String ADMIN_MAIN_PAGE = """
            <!DOCTYPE html>
                   <html lang="ko">
                   <head>
                       <meta charset="UTF-8">
                       <meta name="viewport" content="width=device-width, initial-scale=1.0">
                       <title>Îü∞ÏÑ∏Í∂å Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ</title>
                       <style>
                           * {
                               margin: 0;
                               padding: 0;
                               box-sizing: border-box;
                           }

                           body {
                               font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                               'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
                               -webkit-font-smoothing: antialiased;
                               -moz-osx-font-smoothing: grayscale;
                               background-color: #f5f5f5;
                           }

                           .container {
                               display: flex;
                               flex-direction: column;
                               height: 100vh;
                           }

                           .header {
                               background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                               color: white;
                               padding: 20px 30px;
                               box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                           }

                           .header h1 {
                               font-size: 24px;
                               font-weight: 700;
                           }

                           .content {
                               display: flex;
                               flex: 1;
                               overflow: hidden;
                           }

                           .map-section {
                               flex: 2;
                               position: relative;
                           }

                           #map {
                               width: 100%;
                               height: 100%;
                           }

                           .map-controls {
                               position: absolute;
                               top: 20px;
                               left: 20px;
                               z-index: 1000;
                               background: white;
                               padding: 20px;
                               border-radius: 10px;
                               box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                           }

                           .map-controls h3 {
                               margin-bottom: 15px;
                               color: #2d3748;
                               font-size: 18px;
                           }

                           .control-row {
                               display: flex;
                               gap: 10px;
                               margin-bottom: 10px;
                           }

                           .map-controls input {
                               padding: 10px;
                               border: 2px solid #e2e8f0;
                               border-radius: 5px;
                               font-size: 14px;
                               flex: 1;
                           }

                           .map-controls input:focus {
                               outline: none;
                               border-color: #667eea;
                           }

                           .map-controls button {
                               padding: 10px 20px;
                               border: none;
                               background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                               color: white;
                               border-radius: 5px;
                               cursor: pointer;
                               font-size: 14px;
                               font-weight: 600;
                               transition: all 0.3s ease;
                               white-space: nowrap;
                           }

                           .map-controls button:hover {
                               transform: translateY(-2px);
                               box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
                           }

                           .map-controls button:active {
                               transform: translateY(0);
                           }

                           .map-controls button:disabled {
                               opacity: 0.6;
                               cursor: not-allowed;
                               transform: none;
                           }

                           .course-list-section {
                               flex: 1;
                               background: white;
                               overflow-y: auto;
                               border-left: 1px solid #e2e8f0;
                           }

                           .course-list-header {
                               padding: 20px;
                               border-bottom: 2px solid #e2e8f0;
                               background: #f7fafc;
                           }

                           .course-list-header h2 {
                               color: #2d3748;
                               font-size: 20px;
                               margin-bottom: 5px;
                           }

                           .course-count {
                               color: #718096;
                               font-size: 14px;
                           }

                           .course-list {
                               padding: 10px;
                           }

                           .course-item {
                               background: white;
                               border: 2px solid #e2e8f0;
                               border-radius: 10px;
                               padding: 15px;
                               margin-bottom: 10px;
                               transition: all 0.3s ease;
                               cursor: pointer;
                           }

                           .course-item:hover {
                               border-color: #667eea;
                               box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
                               transform: translateY(-2px);
                           }

                           .course-item.selected {
                               border-color: #667eea;
                               background: #f0f4ff;
                           }

                           .course-name {
                               font-size: 16px;
                               font-weight: 600;
                               color: #2d3748;
                               margin-bottom: 8px;
                           }

                           .course-detail {
                               font-size: 14px;
                               color: #718096;
                               margin-bottom: 4px;
                           }

                           .course-detail strong {
                               color: #4a5568;
                           }

                           .course-actions {
                               margin-top: 10px;
                               display: flex;
                               gap: 8px;
                           }

                           .edit-button {
                               flex: 1;
                               padding: 8px 16px;
                               border: none;
                               background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                               color: white;
                               border-radius: 5px;
                               cursor: pointer;
                               font-size: 13px;
                               font-weight: 600;
                               transition: all 0.3s ease;
                           }

                           .edit-button:hover {
                               transform: translateY(-1px);
                               box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
                           }

                           .delete-button {
                               flex: 1;
                               padding: 8px 16px;
                               border: none;
                               background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
                               color: white;
                               border-radius: 5px;
                               cursor: pointer;
                               font-size: 13px;
                               font-weight: 600;
                               transition: all 0.3s ease;
                           }

                           .delete-button:hover {
                               transform: translateY(-1px);
                               box-shadow: 0 2px 6px rgba(229, 62, 62, 0.4);
                           }

                           .loading {
                               text-align: center;
                               padding: 40px;
                               color: #718096;
                           }

                           .empty-state {
                               text-align: center;
                               padding: 60px 20px;
                               color: #718096;
                           }

                           .empty-state-icon {
                               font-size: 48px;
                               margin-bottom: 20px;
                           }

                           .error-message {
                               background: #fed7d7;
                               color: #c53030;
                               padding: 15px;
                               border-radius: 8px;
                               margin: 10px 20px;
                               font-size: 14px;
                           }

                           .pagination {
                               display: flex;
                               justify-content: center;
                               align-items: center;
                               gap: 10px;
                               padding: 20px;
                               border-top: 2px solid #e2e8f0;
                               background: #f7fafc;
                           }

                           .pagination button {
                               padding: 8px 16px;
                               border: 2px solid #e2e8f0;
                               background: white;
                               color: #4a5568;
                               border-radius: 5px;
                               cursor: pointer;
                               font-size: 14px;
                               font-weight: 600;
                               transition: all 0.3s ease;
                           }

                           .pagination button:hover:not(:disabled) {
                               border-color: #667eea;
                               color: #667eea;
                               transform: translateY(-1px);
                           }

                           .pagination button:disabled {
                               opacity: 0.4;
                               cursor: not-allowed;
                               transform: none;
                           }

                           .page-info {
                               color: #4a5568;
                               font-size: 14px;
                               font-weight: 600;
                               min-width: 80px;
                               text-align: center;
                           }
                       </style>
                   </head>
                   <body>
                   <div class="container">
                       <div class="header">
                           <h1>Îü∞ÏÑ∏Í∂å Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ</h1>
                       </div>
                       <div class="content">
                           <div class="map-section">
                               <div id="map"></div>
                               <div class="map-controls">
                                   <h3>ÏΩîÏä§ Í≤ÄÏÉâ</h3>
                                   <div class="control-row">
                                       <button id="search-btn">ÌòÑÏû¨ ÌôîÎ©¥ÏóêÏÑú Í≤ÄÏÉâ</button>
                                   </div>
                                   <div style="margin-top: 10px; font-size: 13px; color: #718096;">
                                       Í≤ÄÏÉâ Î≤îÏúÑ: <span id="scope-display">-</span>m
                                   </div>
                               </div>
                           </div>
                           <div class="course-list-section">
                               <div class="course-list-header">
                                   <h2>ÏΩîÏä§ Î™©Î°ù</h2>
                                   <div class="course-count">Ï¥ù <span id="course-count">0</span>Í∞úÏùò ÏΩîÏä§</div>
                               </div>
                               <div id="error-container"></div>
                               <div class="course-list" id="course-list">
                                   <div class="empty-state">
                                       <div class="empty-state-icon">üó∫Ô∏è</div>
                                       <p>ÏßÄÎèÑÎ•º Ïù¥ÎèôÌïòÍ≥† Í≤ÄÏÉâ Î≤ÑÌäºÏùÑ ÎàåÎü¨<br>Ï£ºÎ≥Ä ÏΩîÏä§Î•º Í≤ÄÏÉâÌïòÏÑ∏Ïöî</p>
                                   </div>
                               </div>
                               <div class="pagination" id="pagination" style="display: none;">
                                   <button id="prev-page-btn">Ïù¥Ï†Ñ</button>
                                   <div class="page-info">
                                       <span id="current-page">1</span> ÌéòÏù¥ÏßÄ
                                   </div>
                                   <button id="next-page-btn">Îã§Ïùå</button>
                               </div>
                           </div>
                       </div>
                   </div>

                   <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
                   <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=KAKAO_API_KEY_PLACEHOLDER"></script>
                   <script>
                       // ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
                       initializePage();

                       function initializePage() {
                           let map;
                           let polylines = [];
                           let customOverlays = [];
                           let courses = [];
                           let selectedCourseIndex = null; // ÏÑ†ÌÉùÎêú ÏΩîÏä§ Ïù∏Îç±Ïä§
                           let currentPage = 0; // ÌòÑÏû¨ ÌéòÏù¥ÏßÄ Î≤àÌò∏
                           let lastSearchParams = null; // ÎßàÏßÄÎßâ Í≤ÄÏÉâ ÌååÎùºÎØ∏ÌÑ∞ Ï†ÄÏû•
                           let searchCenterMarker = null; // Í≤ÄÏÉâ Ï§ëÏã¨Ï†ê ÎßàÏª§

                           // Ïπ¥Ïπ¥Ïò§ Îßµ Ï¥àÍ∏∞Ìôî
                           const mapContainer = document.getElementById('map');
                           const mapOption = {
                               center: new kakao.maps.LatLng(37.5665, 126.9780), // ÏÑúÏö∏ ÏãúÏ≤≠ Í∏∞Î≥∏ ÏúÑÏπò
                               level: 5
                           };

                           map = new kakao.maps.Map(mapContainer, mapOption);

                           // ÏÇ¨Ïö©Ïûê ÌòÑÏû¨ ÏúÑÏπòÎ°ú Ïù¥Îèô
                           if (navigator.geolocation) {
                               navigator.geolocation.getCurrentPosition(function (position) {
                                   const lat = position.coords.latitude;
                                   const lng = position.coords.longitude;
                                   const locPosition = new kakao.maps.LatLng(lat, lng);
                                   map.setCenter(locPosition);
                               });
                           }

                           // ÏóêÎü¨ Î©îÏãúÏßÄ ÌëúÏãú
                           function showError(message) {
                               const errorContainer = document.getElementById('error-container');
                               errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
                               setTimeout(() => {
                                   errorContainer.innerHTML = '';
                               }, 5000);
                           }

                           // Ìè¥Î¶¨ÎùºÏù∏ Ï†úÍ±∞
                           function clearPolylines() {
                               polylines.forEach(polyline => polyline.setMap(null));
                               polylines = [];
                           }

                           // Ïª§Ïä§ÌÖÄ Ïò§Î≤ÑÎ†àÏù¥ Ï†úÍ±∞
                           function clearCustomOverlays() {
                               customOverlays.forEach(overlay => overlay.setMap(null));
                               customOverlays = [];
                           }

                           // Í≤ÄÏÉâ Ï§ëÏã¨Ï†ê ÎßàÏª§ ÌëúÏãú
                           function showSearchCenterMarker() {
                               // Í∏∞Ï°¥ ÎßàÏª§ Ï†úÍ±∞
                               if (searchCenterMarker) {
                                   searchCenterMarker.setMap(null);
                               }

                               if (!lastSearchParams) return;

                               // ÏÉà ÎßàÏª§ ÏÉùÏÑ±
                               const markerPosition = new kakao.maps.LatLng(lastSearchParams.mapLat, lastSearchParams.mapLng);
                               searchCenterMarker = new kakao.maps.Marker({
                                   position: markerPosition,
                                   map: map
                               });
                           }

                           // ÏßÄÎèÑ Î≤îÏúÑ Í∏∞Î∞ò scope Í≥ÑÏÇ∞
                           function calculateScope() {
                               const bounds = map.getBounds();
                               const sw = bounds.getSouthWest();
                               const ne = bounds.getNorthEast();
                               const center = map.getCenter();

                               // Ï§ëÏã¨Ï†êÏóêÏÑú ÎÇ®ÏÑúÏ™Ω Î™®ÏÑúÎ¶¨ÍπåÏßÄÏùò Í±∞Î¶¨ Í≥ÑÏÇ∞ (Haversine formula)
                               const R = 6371000; // ÏßÄÍµ¨ Î∞òÏßÄÎ¶Ñ (ÎØ∏ÌÑ∞)
                               const lat1 = center.getLat() * Math.PI / 180;
                               const lat2 = sw.getLat() * Math.PI / 180;
                               const deltaLat = (sw.getLat() - center.getLat()) * Math.PI / 180;
                               const deltaLng = (sw.getLng() - center.getLng()) * Math.PI / 180;

                               const a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
                                   Math.cos(lat1) * Math.cos(lat2) *
                                   Math.sin(deltaLng / 2) * Math.sin(deltaLng / 2);
                               const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                               const distance = R * c;

                               // ÎåÄÍ∞ÅÏÑ† Í±∞Î¶¨Ïù¥ÎØÄÎ°ú ÏïΩÍ∞Ñ Ïó¨Ïú†Î•º ÎëêÍ≥† Î∞òÏò¨Î¶º
                               const calculatedScope = Math.ceil(distance * 1.2);
                               // ÏµúÏÜå 1000m, ÏµúÎåÄ 3000mÎ°ú Ï†úÌïú
                               return Math.max(1000, Math.min(3000, calculatedScope));
                           }

                           // scope ÎîîÏä§ÌîåÎ†àÏù¥ ÏóÖÎç∞Ïù¥Ìä∏
                           function updateScopeDisplay() {
                               const scope = calculateScope();
                               document.getElementById('scope-display').textContent = scope.toLocaleString();
                           }

                           // ÏΩîÏä§ Í≤ÄÏÉâ (ÏÉàÎ°úÏö¥ Í≤ÄÏÉâ ÏãúÏûë)
                           async function searchCourses() {
                               const center = map.getCenter();
                               const scope = calculateScope();

                               // Í≤ÄÏÉâ ÌååÎùºÎØ∏ÌÑ∞ Ï†ÄÏû•
                               lastSearchParams = {
                                   mapLat: center.getLat(),
                                   mapLng: center.getLng(),
                                   scope: scope
                               };

                               // ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
                               currentPage = 0;

                               // Ï≤´ ÌéòÏù¥ÏßÄ Î°úÎìú
                               await loadCoursesPage(0);
                           }

                           // ÌäπÏ†ï ÌéòÏù¥ÏßÄÏùò ÏΩîÏä§ Î°úÎìú
                           async function loadCoursesPage(page) {
                               if (!lastSearchParams) return;

                               const searchBtn = document.getElementById('search-btn');
                               searchBtn.disabled = true;
                               searchBtn.textContent = 'Í≤ÄÏÉâ Ï§ë...';

                               try {
                                   const response = await axios.get('/courses', {
                                       params: {
                                           ...lastSearchParams,
                                           page: page
                                       },
                                       withCredentials: true
                                   });

                                   console.log('API ÏùëÎãµ ÏÑ±Í≥µ:', response.data);
                                   courses = response.data;
                                   currentPage = page;

                                   try {
                                       displayCourses(courses);
                                       drawAllCoursesOnMap(courses);
                                       updatePagination();
                                   } catch (displayError) {
                                       console.error('ÏΩîÏä§ ÌëúÏãú Ï§ë ÏóêÎü¨:', displayError);
                                       showError('ÏΩîÏä§Î•º ÌëúÏãúÌïòÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + displayError.message);
                                   }
                               } catch (error) {
                                   console.error('ÏΩîÏä§ Í≤ÄÏÉâ Ïã§Ìå®:', error);
                                   console.error('ÏóêÎü¨ ÏÉÅÏÑ∏:', error.response, error.request, error.message);
                                   if (error.response && error.response.status === 401) {
                                       alert('Î°úÍ∑∏Ïù∏ ÏÑ∏ÏÖòÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§.');
                                       window.location.href = '/admin/login';
                                   } else {
                                       showError('ÏΩîÏä§ Í≤ÄÏÉâÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                                   }
                               } finally {
                                   searchBtn.disabled = false;
                                   searchBtn.textContent = 'ÌòÑÏû¨ ÌôîÎ©¥ÏóêÏÑú Í≤ÄÏÉâ';
                               }
                           }

                           // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò UI ÏóÖÎç∞Ïù¥Ìä∏
                           function updatePagination() {
                               const pagination = document.getElementById('pagination');
                               const prevBtn = document.getElementById('prev-page-btn');
                               const nextBtn = document.getElementById('next-page-btn');
                               const currentPageSpan = document.getElementById('current-page');

                               // ÌéòÏù¥ÏßÄ Î≤àÌò∏ ÏóÖÎç∞Ïù¥Ìä∏ (1Î∂ÄÌÑ∞ ÏãúÏûëÌïòÎèÑÎ°ù ÌëúÏãú)
                               currentPageSpan.textContent = currentPage + 1;

                               // Ïù¥Ï†Ñ Î≤ÑÌäº ÌôúÏÑ±Ìôî/ÎπÑÌôúÏÑ±Ìôî
                               prevBtn.disabled = currentPage === 0;

                               // Îã§Ïùå Î≤ÑÌäº ÌôúÏÑ±Ìôî/ÎπÑÌôúÏÑ±Ìôî (10Í∞ú ÎØ∏ÎßåÏù¥Î©¥ ÎßàÏßÄÎßâ ÌéòÏù¥ÏßÄ)
                               nextBtn.disabled = courses.length < 10;

                               // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò ÌëúÏãú
                               if (courses.length > 0) {
                                   pagination.style.display = 'flex';
                               } else {
                                   pagination.style.display = 'none';
                               }
                           }

                           // ÏΩîÏä§ Î™©Î°ù ÌëúÏãú
                           function displayCourses(courses) {
                               const courseList = document.getElementById('course-list');
                               const courseCount = document.getElementById('course-count');

                               courseCount.textContent = courses.length;

                               if (courses.length === 0) {
                                   courseList.innerHTML = `
                                       <div class="empty-state">
                                           <div class="empty-state-icon">üîç</div>
                                           <p>Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.<br>Îã§Î•∏ ÏúÑÏπòÎÇò Î≤îÏúÑÎ°ú Îã§Ïãú Í≤ÄÏÉâÌï¥Î≥¥ÏÑ∏Ïöî.</p>
                                       </div>
                                   `;
                                   return;
                               }

                               courseList.innerHTML = courses.map((course, index) => `
                                   <div class="course-item" data-index="${index}" data-course-id="${course.id}" data-course-name="${course.name}">
                                       <div class="course-name">${course.name}</div>
                                       <div class="course-detail"><strong>ÏΩîÏä§ Í∏∏Ïù¥:</strong> ${(course.length / 1000).toFixed(2)} km</div>
                                       <div class="course-detail"><strong>ÎèÑÎ°ú ÌÉÄÏûÖ:</strong> ${course.roadType}</div>
                                       <div class="course-detail"><strong>ÎÇúÏù¥ÎèÑ:</strong> ${course.difficulty}</div>
                                       ${course.distance !== null ? `<div class="course-detail"><strong>Í±∞Î¶¨:</strong> ${(course.distance / 1000).toFixed(2)} km</div>` : ''}
                                       <div class="course-actions">
                                           <button class="edit-button" onclick="event.stopPropagation(); window.location.href='/admin/courses/edit?id=${course.id}'">Ìé∏Ïßë</button>
                                           <button class="delete-button" data-course-id="${course.id}" data-course-name="${course.name}">ÏÇ≠Ï†ú</button>
                                       </div>
                                   </div>
                               `).join('');

                               // ÏΩîÏä§ ÏïÑÏù¥ÌÖú ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
                               document.querySelectorAll('.course-item').forEach(item => {
                                   item.addEventListener('click', function () {
                                       const index = parseInt(this.dataset.index);
                                       selectCourse(index);
                                   });
                               });

                               // ÏÇ≠Ï†ú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
                               document.querySelectorAll('.delete-button').forEach(button => {
                                   button.addEventListener('click', async function (event) {
                                       event.stopPropagation();
                                       const courseId = this.dataset.courseId;
                                       const courseName = this.dataset.courseName;

                                       if (!confirm(`Ï†ïÎßêÎ°ú "${courseName}" ÏΩîÏä§Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?

            Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`)) {
                                           return;
                                       }

                                       try {
                                           await axios.delete(`/admin/courses/${courseId}`, {
                                               withCredentials: true
                                           });

                                           alert(`"${courseName}" ÏΩîÏä§Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`);

                                           // ÌòÑÏû¨ ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ®
                                           if (lastSearchParams) {
                                               await loadCoursesPage(currentPage);
                                           }
                                       } catch (error) {
                                           console.error('ÏΩîÏä§ ÏÇ≠Ï†ú Ïã§Ìå®:', error);
                                           if (error.response && error.response.status === 401) {
                                               alert('Î°úÍ∑∏Ïù∏ ÏÑ∏ÏÖòÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§.');
                                               window.location.href = '/admin/login';
                                           } else if (error.response && error.response.status === 404) {
                                               showError('ÏÇ≠Ï†úÌïòÎ†§Îäî ÏΩîÏä§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                                           } else {
                                               showError('ÏΩîÏä§ ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                                           }
                                       }
                                   });
                               });
                           }

                           // ÏΩîÏä§Ïùò ÏãúÏûë Ï¢åÌëú Í∞ÄÏ†∏Ïò§Í∏∞
                           function getCourseStartCoordinate(course) {
                               if (course.segments && course.segments.length > 0 &&
                                   course.segments[0].coordinates && course.segments[0].coordinates.length > 0) {
                                   return course.segments[0].coordinates[0];
                               }
                               return null;
                           }

                           // inclineTypeÏóê Îî∞Î•∏ ÏÉâÏÉÅ Î∞òÌôò
                           function getColorByInclineType(inclineType) {
                               switch (inclineType) {
                                   case 'UPHILL':
                                       return '#FF0000'; // Îπ®Í∞ÑÏÉâ (Ïò§Î•¥Îßâ)
                                   case 'FLAT':
                                       return '#00FF00'; // Ï¥àÎ°ùÏÉâ (ÌèâÏßÄ)
                                   case 'DOWNHILL':
                                       return '#0000FF'; // ÌååÎûÄÏÉâ (ÎÇ¥Î¶¨Îßâ)
                                   default:
                                       return '#808080'; // ÌöåÏÉâ (Í∏∞ÌÉÄ)
                               }
                           }

                           // ÏΩîÏä§ ÏÑ†ÌÉù
                           function selectCourse(index) {
                               // Ïù¥Ï†Ñ ÏÑ†ÌÉù Ï†úÍ±∞
                               document.querySelectorAll('.course-item').forEach(item => {
                                   item.classList.remove('selected');
                               });

                               // ÏÉàÎ°úÏö¥ ÏÑ†ÌÉù
                               document.querySelectorAll('.course-item')[index].classList.add('selected');

                               // ÏÑ†ÌÉùÌïú ÏΩîÏä§Î•º Í∞ïÏ°∞ÌïòÏó¨ ÏßÄÎèÑÏóê Í∑∏Î¶¨Í∏∞
                               drawAllCoursesWithSelection(index);
                           }

                           // Î™®Îì† ÏΩîÏä§Î•º ÏßÄÎèÑÏóê Í∑∏Î¶¨Í∏∞ (Ï¥àÍ∏∞ ÏÉÅÌÉú: Î™®Îëê ÌöåÏÉâ)
                           function drawAllCoursesOnMap(courses) {
                               // Í∏∞Ï°¥ Ìè¥Î¶¨ÎùºÏù∏Í≥º Ïò§Î≤ÑÎ†àÏù¥ Ï†úÍ±∞
                               clearPolylines();
                               clearCustomOverlays();

                               // Í≤ÄÏÉâ Ï§ëÏã¨Ï†ê ÎßàÏª§ ÌëúÏãú
                               showSearchCenterMarker();

                               // ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
                               selectedCourseIndex = null;

                               courses.forEach((course, courseIndex) => {
                                   if (!course.segments || course.segments.length === 0) {
                                       return;
                                   }

                                   // Í∞Å segmentÎ•º ÏàúÌöåÌïòÎ©∞ Ìè¥Î¶¨ÎùºÏù∏ Í∑∏Î¶¨Í∏∞
                                   course.segments.forEach(segment => {
                                       if (!segment.coordinates || segment.coordinates.length === 0) {
                                           return;
                                       }

                                       // Ï¢åÌëú Î∞∞Ïó¥ÏùÑ Ïπ¥Ïπ¥Ïò§Îßµ LatLng Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
                                       const path = segment.coordinates.map(coord =>
                                           new kakao.maps.LatLng(coord.latitude, coord.longitude)
                                       );

                                       // Ï¥àÍ∏∞ ÏÉÅÌÉúÎäî Î™®Îëê ÌöåÏÉâ
                                       const strokeColor = '#888888';

                                       // Ìè¥Î¶¨ÎùºÏù∏ ÏÉùÏÑ±
                                       const polyline = new kakao.maps.Polyline({
                                           path: path,
                                           strokeWeight: 4,
                                           strokeColor: strokeColor,
                                           strokeOpacity: 0.7,
                                           strokeStyle: 'solid'
                                       });

                                       // Ìè¥Î¶¨ÎùºÏù∏ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
                                       kakao.maps.event.addListener(polyline, 'click', function() {
                                           selectCourse(courseIndex);
                                       });

                                       // Ìè¥Î¶¨ÎùºÏù∏ ÎßàÏö∞Ïä§Ïò§Î≤Ñ Ìö®Í≥º
                                       kakao.maps.event.addListener(polyline, 'mouseover', function() {
                                           polyline.setOptions({
                                               strokeOpacity: 1.0
                                           });
                                       });

                                       kakao.maps.event.addListener(polyline, 'mouseout', function() {
                                           polyline.setOptions({
                                               strokeOpacity: 0.7
                                           });
                                       });

                                       // ÏßÄÎèÑÏóê ÌëúÏãú
                                       polyline.setMap(map);
                                       polylines.push(polyline);
                                   });

                                   // ÏΩîÏä§ ÏãúÏûëÏ†êÏóê Ïù¥Î¶Ñ ÎùºÎ≤® Ï∂îÍ∞Ä
                                   const startCoord = getCourseStartCoordinate(course);
                                   if (startCoord) {
                                       const position = new kakao.maps.LatLng(startCoord.latitude, startCoord.longitude);

                                       const content = `<div style="
                                           padding: 5px 10px;
                                           background: white;
                                           border: 2px solid #cccccc;
                                           border-radius: 5px;
                                           font-size: 12px;
                                           font-weight: 400;
                                           color: #718096;
                                           box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                                           white-space: nowrap;
                                           cursor: pointer;
                                       ">${course.name}</div>`;

                                       const customOverlay = new kakao.maps.CustomOverlay({
                                           position: position,
                                           content: content,
                                           yAnchor: 1.5,
                                           clickable: true
                                       });

                                       customOverlay.setMap(map);
                                       customOverlays.push(customOverlay);

                                       // ÎùºÎ≤® ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä (DOM ÏöîÏÜåÏóê ÏßÅÏ†ë Ï∂îÍ∞Ä)
                                       setTimeout(() => {
                                           const overlayElement = customOverlay.getContent();
                                           if (overlayElement && overlayElement.addEventListener) {
                                               overlayElement.addEventListener('click', function() {
                                                   selectCourse(courseIndex);
                                               });
                                           }
                                       }, 0);
                                   }
                               });
                           }

                           // ÏÑ†ÌÉùÎêú ÏΩîÏä§Î•º Í∞ïÏ°∞ÌïòÏó¨ Î™®Îì† ÏΩîÏä§Î•º ÏßÄÎèÑÏóê Í∑∏Î¶¨Í∏∞
                           function drawAllCoursesWithSelection(selectedIndex) {
                               // Í∏∞Ï°¥ Ìè¥Î¶¨ÎùºÏù∏Í≥º Ïò§Î≤ÑÎ†àÏù¥ Ï†úÍ±∞
                               clearPolylines();
                               clearCustomOverlays();

                               // Í≤ÄÏÉâ Ï§ëÏã¨Ï†ê ÎßàÏª§ ÌëúÏãú (Ïú†ÏßÄ)
                               showSearchCenterMarker();

                               courses.forEach((course, courseIndex) => {
                                   if (!course.segments || course.segments.length === 0) {
                                       return;
                                   }

                                   const isSelected = courseIndex === selectedIndex;

                                   // Í∞Å segmentÎ•º ÏàúÌöåÌïòÎ©∞ Ìè¥Î¶¨ÎùºÏù∏ Í∑∏Î¶¨Í∏∞
                                   course.segments.forEach(segment => {
                                       if (!segment.coordinates || segment.coordinates.length === 0) {
                                           return;
                                       }

                                       // Ï¢åÌëú Î∞∞Ïó¥ÏùÑ Ïπ¥Ïπ¥Ïò§Îßµ LatLng Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
                                       const path = segment.coordinates.map(coord =>
                                           new kakao.maps.LatLng(coord.latitude, coord.longitude)
                                       );

                                       // ÏÑ†ÌÉùÎêú ÏΩîÏä§Îäî ÏõêÎûò ÏÉâÏÉÅ, ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùÄ ÏΩîÏä§Îäî ÌöåÏÉâ
                                       const strokeColor = isSelected
                                           ? getColorByInclineType(segment.inclineType)
                                           : '#888888'; // ÏßÑÌïú ÌöåÏÉâ

                                       // Ìè¥Î¶¨ÎùºÏù∏ ÏÉùÏÑ±
                                       const polyline = new kakao.maps.Polyline({
                                           path: path,
                                           strokeWeight: isSelected ? 6 : 4, // ÏÑ†ÌÉùÎêú ÏΩîÏä§Îäî Îçî ÎëêÍªçÍ≤å
                                           strokeColor: strokeColor,
                                           strokeOpacity: isSelected ? 0.9 : 0.7, // ÏÑ†ÌÉùÎêòÏßÄ ÏïäÏùÄ ÏΩîÏä§ÎèÑ Ïûò Î≥¥Ïù¥ÎèÑÎ°ù
                                           strokeStyle: 'solid'
                                       });

                                       // Ìè¥Î¶¨ÎùºÏù∏ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
                                       kakao.maps.event.addListener(polyline, 'click', function() {
                                           selectCourse(courseIndex);
                                       });

                                       // Ìè¥Î¶¨ÎùºÏù∏ ÎßàÏö∞Ïä§Ïò§Î≤Ñ Ìö®Í≥º
                                       kakao.maps.event.addListener(polyline, 'mouseover', function() {
                                           polyline.setOptions({
                                               strokeOpacity: 1.0
                                           });
                                       });

                                       kakao.maps.event.addListener(polyline, 'mouseout', function() {
                                           polyline.setOptions({
                                               strokeOpacity: isSelected ? 0.9 : 0.7
                                           });
                                       });

                                       // ÏßÄÎèÑÏóê ÌëúÏãú
                                       polyline.setMap(map);
                                       polylines.push(polyline);
                                   });

                                   // ÏΩîÏä§ ÏãúÏûëÏ†êÏóê Ïù¥Î¶Ñ ÎùºÎ≤® Ï∂îÍ∞Ä
                                   const startCoord = getCourseStartCoordinate(course);
                                   if (startCoord) {
                                       const position = new kakao.maps.LatLng(startCoord.latitude, startCoord.longitude);

                                       const content = `<div style="
                                           padding: 5px 10px;
                                           background: white;
                                           border: 2px solid ${isSelected ? '#667eea' : '#cccccc'};
                                           border-radius: 5px;
                                           font-size: 12px;
                                           font-weight: ${isSelected ? '700' : '400'};
                                           color: ${isSelected ? '#2d3748' : '#718096'};
                                           box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                                           white-space: nowrap;
                                           cursor: pointer;
                                       ">${course.name}</div>`;

                                       const customOverlay = new kakao.maps.CustomOverlay({
                                           position: position,
                                           content: content,
                                           yAnchor: 1.5,
                                           clickable: true
                                       });

                                       customOverlay.setMap(map);
                                       customOverlays.push(customOverlay);

                                       // ÎùºÎ≤® ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä (DOM ÏöîÏÜåÏóê ÏßÅÏ†ë Ï∂îÍ∞Ä)
                                       setTimeout(() => {
                                           const overlayElement = customOverlay.getContent();
                                           if (overlayElement && overlayElement.addEventListener) {
                                               overlayElement.addEventListener('click', function() {
                                                   selectCourse(courseIndex);
                                               });
                                           }
                                       }, 0);
                                   }
                               });
                           }

                           // ÏßÄÎèÑ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà - Ï§å/ÎìúÎûòÍ∑∏ Ïãú scope ÏóÖÎç∞Ïù¥Ìä∏
                           kakao.maps.event.addListener(map, 'zoom_changed', updateScopeDisplay);
                           kakao.maps.event.addListener(map, 'dragend', updateScopeDisplay);
                           kakao.maps.event.addListener(map, 'tilesloaded', function() {
                               // Ï¥àÍ∏∞ Î°úÎìú Ïãú scope ÌëúÏãú
                               updateScopeDisplay();
                           });

                           // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
                           document.getElementById('search-btn').addEventListener('click', searchCourses);
                           document.getElementById('prev-page-btn').addEventListener('click', function() {
                               if (currentPage > 0) {
                                   loadCoursesPage(currentPage - 1);
                               }
                           });
                           document.getElementById('next-page-btn').addEventListener('click', function() {
                               loadCoursesPage(currentPage + 1);
                           });
                       }
                   </script>
                   </body>
                   </html>

            """;

    private static final String ADMIN_EDIT_PAGE = """
            <!DOCTYPE html>
            <html lang="ko">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>ÏΩîÏä§ Ìé∏Ïßë - Îü∞ÏÑ∏Í∂å</title>
                <style>
                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                    }

                    body {
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
                        -webkit-font-smoothing: antialiased;
                        -moz-osx-font-smoothing: grayscale;
                        background-color: #f5f5f5;
                    }

                    .container {
                        display: flex;
                        flex-direction: column;
                        min-height: 100vh;
                    }

                    .header {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 20px 30px;
                        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }

                    .header h1 {
                        font-size: 24px;
                        font-weight: 700;
                    }

                    .header-buttons {
                        display: flex;
                        gap: 10px;
                    }

                    .back-button, .save-button {
                        padding: 10px 20px;
                        border: 2px solid white;
                        background: transparent;
                        color: white;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 600;
                        transition: all 0.3s ease;
                    }

                    .back-button:hover {
                        background: white;
                        color: #667eea;
                    }

                    .save-button {
                        background: white;
                        color: #667eea;
                    }

                    .save-button:hover {
                        background: #f0f0f0;
                        transform: translateY(-2px);
                        box-shadow: 0 4px 8px rgba(255, 255, 255, 0.3);
                    }

                    .save-button:disabled {
                        opacity: 0.5;
                        cursor: not-allowed;
                        transform: none;
                    }

                    .content {
                        display: flex;
                        height: 70vh;
                        overflow: hidden;
                    }

                    .map-section {
                        flex: 3;
                        position: relative;
                    }

                    #map {
                        width: 100%;
                        height: 100%;
                    }

                    .map-controls {
                        position: absolute;
                        top: 20px;
                        left: 20px;
                        z-index: 1000;
                        background: white;
                        padding: 20px;
                        border-radius: 10px;
                        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                        max-width: 300px;
                    }

                    .map-controls h3 {
                        margin-bottom: 15px;
                        color: #2d3748;
                        font-size: 18px;
                    }

                    .map-controls p {
                        font-size: 14px;
                        color: #718096;
                        margin-bottom: 10px;
                        line-height: 1.5;
                    }

                    .control-button {
                        padding: 10px 20px;
                        border: none;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 600;
                        transition: all 0.3s ease;
                        width: 100%;
                        margin-top: 10px;
                    }

                    .control-button:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
                    }

                    .control-button:active {
                        transform: translateY(0);
                    }

                    .control-button:disabled {
                        opacity: 0.6;
                        cursor: not-allowed;
                        transform: none;
                    }

                    .control-button.secondary {
                        background: #e2e8f0;
                        color: #2d3748;
                    }

                    .control-button.secondary:hover {
                        background: #cbd5e0;
                    }

                    .info-section {
                        flex: 1;
                        background: white;
                        overflow-y: auto;
                        border-left: 1px solid #e2e8f0;
                        padding: 20px;
                    }

                    .info-section h2 {
                        color: #2d3748;
                        font-size: 20px;
                        margin-bottom: 20px;
                    }

                    .course-info {
                        margin-bottom: 20px;
                    }

                    .info-item {
                        margin-bottom: 15px;
                        padding-bottom: 15px;
                        border-bottom: 1px solid #e2e8f0;
                    }

                    .info-item:last-child {
                        border-bottom: none;
                    }

                    .info-label {
                        font-size: 14px;
                        font-weight: 600;
                        color: #4a5568;
                        margin-bottom: 5px;
                    }

                    .info-value {
                        font-size: 14px;
                        color: #2d3748;
                    }

                    .info-value.editable {
                        width: 100%;
                    }

                    .info-input {
                        width: 100%;
                        padding: 8px 12px;
                        border: 2px solid #e2e8f0;
                        border-radius: 6px;
                        font-size: 14px;
                        color: #2d3748;
                        transition: all 0.3s ease;
                        outline: none;
                    }

                    .info-input:focus {
                        border-color: #667eea;
                        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                    }

                    .info-select {
                        width: 100%;
                        padding: 8px 12px;
                        border: 2px solid #e2e8f0;
                        border-radius: 6px;
                        font-size: 14px;
                        color: #2d3748;
                        transition: all 0.3s ease;
                        outline: none;
                        background-color: white;
                        cursor: pointer;
                    }

                    .info-select:focus {
                        border-color: #667eea;
                        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                    }

                    .info-select:hover {
                        border-color: #cbd5e0;
                    }

                    .segment-list {
                        margin-top: 20px;
                    }

                    .segment-item {
                        background: #f7fafc;
                        border: 1px solid #e2e8f0;
                        border-radius: 8px;
                        padding: 15px;
                        margin-bottom: 10px;
                    }

                    .segment-header {
                        font-weight: 600;
                        color: #2d3748;
                        margin-bottom: 10px;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }

                    .incline-badge {
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 12px;
                        font-weight: 600;
                    }

                    .incline-badge.UPHILL {
                        background: #fed7d7;
                        color: #c53030;
                    }

                    .incline-badge.FLAT {
                        background: #c6f6d5;
                        color: #276749;
                    }

                    .incline-badge.DOWNHILL {
                        background: #bee3f8;
                        color: #2c5282;
                    }

                    .coordinate-count {
                        font-size: 12px;
                        color: #718096;
                    }

                    .loading {
                        text-align: center;
                        padding: 40px;
                        color: #718096;
                    }

                    .error-message {
                        background: #fed7d7;
                        color: #c53030;
                        padding: 15px;
                        border-radius: 8px;
                        margin-bottom: 20px;
                        font-size: 14px;
                    }

                    .success-message {
                        background: #c6f6d5;
                        color: #276749;
                        padding: 15px;
                        border-radius: 8px;
                        margin-bottom: 20px;
                        font-size: 14px;
                    }

                    .marker-dragging {
                        cursor: move;
                    }

                    .coordinates-section {
                        background: white;
                        padding: 30px;
                        border-top: 2px solid #e2e8f0;
                    }

                    .coordinates-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 15px;
                    }

                    .coordinates-title {
                        font-size: 18px;
                        font-weight: 700;
                        color: #2d3748;
                    }

                    .bulk-actions {
                        display: flex;
                        gap: 10px;
                    }

                    .bulk-button {
                        padding: 8px 16px;
                        border: none;
                        border-radius: 6px;
                        font-size: 13px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    }

                    .bulk-button.primary {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                    }

                    .bulk-button.primary:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
                    }

                    .bulk-button.secondary {
                        background: #e2e8f0;
                        color: #2d3748;
                    }

                    .bulk-button.secondary:hover {
                        background: #cbd5e0;
                    }

                    .bulk-button:disabled {
                        opacity: 0.5;
                        cursor: not-allowed;
                        transform: none;
                    }

                    .coordinates-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-top: 10px;
                        font-size: 13px;
                    }

                    .coordinates-table thead {
                        background: #f7fafc;
                        position: sticky;
                        top: 0;
                        z-index: 10;
                    }

                    .coordinates-table th {
                        padding: 12px 8px;
                        text-align: left;
                        font-weight: 600;
                        color: #4a5568;
                        border-bottom: 2px solid #e2e8f0;
                    }

                    .coordinates-table td {
                        padding: 10px 8px;
                        border-bottom: 1px solid #e2e8f0;
                        color: #2d3748;
                    }

                    .coordinates-table tr:hover {
                        background: #f7fafc;
                    }

                    .coordinates-table tr.selected {
                        background: #e6f0ff;
                    }

                    .coord-checkbox {
                        width: 18px;
                        height: 18px;
                        cursor: pointer;
                    }

                    .coord-number {
                        font-family: 'Monaco', 'Menlo', monospace;
                        color: #667eea;
                        font-weight: 600;
                    }

                    .coord-value {
                        font-family: 'Monaco', 'Menlo', monospace;
                        font-size: 12px;
                    }

                    .coord-edit-btn {
                        padding: 4px 12px;
                        border: 1px solid #667eea;
                        background: white;
                        color: #667eea;
                        border-radius: 4px;
                        font-size: 12px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    }

                    .coord-edit-btn:hover {
                        background: #667eea;
                        color: white;
                    }

                    .segment-group-header {
                        background: #edf2f7;
                        font-weight: 700;
                        color: #2d3748;
                    }

                    .select-all-label {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        font-size: 13px;
                        color: #4a5568;
                        cursor: pointer;
                    }

                    /* Î™®Îã¨ Ïä§ÌÉÄÏùº */
                    .modal-overlay {
                        display: none;
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.5);
                        z-index: 9999;
                        justify-content: center;
                        align-items: center;
                    }

                    .modal-overlay.active {
                        display: flex;
                    }

                    .modal-content {
                        background: white;
                        border-radius: 12px;
                        padding: 30px;
                        max-width: 500px;
                        width: 90%;
                        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
                        animation: modalSlideIn 0.3s ease;
                    }

                    @keyframes modalSlideIn {
                        from {
                            transform: translateY(-50px);
                            opacity: 0;
                        }
                        to {
                            transform: translateY(0);
                            opacity: 1;
                        }
                    }

                    .modal-header {
                        font-size: 20px;
                        font-weight: 700;
                        color: #2d3748;
                        margin-bottom: 20px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }

                    .modal-close {
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        color: #718096;
                        padding: 0;
                        width: 30px;
                        height: 30px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 4px;
                        transition: all 0.2s ease;
                    }

                    .modal-close:hover {
                        background: #e2e8f0;
                        color: #2d3748;
                    }

                    .modal-form {
                        display: flex;
                        flex-direction: column;
                        gap: 20px;
                    }

                    .modal-form-group {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                    }

                    .modal-label {
                        font-size: 14px;
                        font-weight: 600;
                        color: #4a5568;
                    }

                    .modal-input {
                        width: 100%;
                        padding: 12px 16px;
                        border: 2px solid #e2e8f0;
                        border-radius: 8px;
                        font-size: 14px;
                        color: #2d3748;
                        transition: all 0.3s ease;
                        outline: none;
                        font-family: 'Monaco', 'Menlo', monospace;
                    }

                    .modal-input:focus {
                        border-color: #667eea;
                        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                    }

                    .modal-actions {
                        display: flex;
                        gap: 10px;
                        margin-top: 10px;
                    }

                    .modal-button {
                        flex: 1;
                        padding: 12px 24px;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    }

                    .modal-button.primary {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                    }

                    .modal-button.primary:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
                    }

                    .modal-button.secondary {
                        background: #e2e8f0;
                        color: #2d3748;
                    }

                    .modal-button.secondary:hover {
                        background: #cbd5e0;
                    }
                </style>
            </head>
            <body>
            <div class="container">
                <div class="header">
                    <h1>ÏΩîÏä§ Ìé∏Ïßë</h1>
                    <div class="header-buttons">
                        <button class="save-button" onclick="saveCourse()">Ï†ÄÏû•</button>
                        <button class="back-button" onclick="window.history.back()">‚Üê Îí§Î°ú Í∞ÄÍ∏∞</button>
                    </div>
                </div>
                <div class="content">
                    <div class="map-section">
                        <div id="map"></div>
                        <div class="map-controls">
                            <h3>Ìé∏Ïßë Í∞ÄÏù¥Îìú</h3>
                            <p>ÏßÄÎèÑ ÏúÑÏùò ÎßàÏª§Î•º ÎìúÎûòÍ∑∏ÌïòÏó¨ ÏΩîÏä§ Ï¢åÌëúÎ•º ÏàòÏ†ïÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                            <p>Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏùÄ ÏûêÎèôÏúºÎ°ú Ï†ÄÏû•Îê©ÎãàÎã§.</p>
                            <button class="control-button secondary" onclick="resetChanges()">Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ï¥àÍ∏∞Ìôî</button>
                        </div>
                    </div>
                    <div class="info-section">
                        <h2>ÏΩîÏä§ Ï†ïÎ≥¥</h2>
                        <div id="message-container"></div>
                        <div id="course-info" class="loading">ÏΩîÏä§ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
                    </div>
                </div>
                <div id="coordinates-container" class="coordinates-section" style="display: none;">
                    <div class="loading">Ï¢åÌëú Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
                </div>
            </div>

            <!-- Ï¢åÌëú ÏàòÏ†ï Î™®Îã¨ -->
            <div id="coordinate-edit-modal" class="modal-overlay">
                <div class="modal-content">
                    <div class="modal-header">
                        <span>Ï¢åÌëú ÏàòÏ†ï</span>
                        <button class="modal-close" onclick="closeCoordinateModal()">&times;</button>
                    </div>
                    <div class="modal-form">
                        <div class="modal-form-group">
                            <label class="modal-label" for="modal-latitude">ÏúÑÎèÑ (Latitude)</label>
                            <input type="number" id="modal-latitude" class="modal-input" step="0.000001" placeholder="Ïòà: 37.566535">
                        </div>
                        <div class="modal-form-group">
                            <label class="modal-label" for="modal-longitude">Í≤ΩÎèÑ (Longitude)</label>
                            <input type="number" id="modal-longitude" class="modal-input" step="0.000001" placeholder="Ïòà: 126.978000">
                        </div>
                        <div class="modal-form-group">
                            <label class="modal-label" for="modal-elevation">Í≥†ÎèÑ (Elevation, m)</label>
                            <input type="number" id="modal-elevation" class="modal-input" step="0.1" placeholder="Ïòà: 15.5">
                        </div>
                        <div class="modal-actions">
                            <button class="modal-button secondary" onclick="closeCoordinateModal()">Ï∑®ÏÜå</button>
                            <button class="modal-button primary" onclick="saveCoordinateFromModal()">ÌôïÏù∏</button>
                        </div>
                    </div>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
            <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=71f900d9b14c079c34329764a15e7ae2"></script>
            <script>
                // URLÏóêÏÑú ÏΩîÏä§ ID Ï∂îÏ∂ú
                const urlParams = new URLSearchParams(window.location.search);
                const courseId = urlParams.get('id');

                if (!courseId) {
                    alert('ÏΩîÏä§ IDÍ∞Ä ÏßÄÏ†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                    window.history.back();
                }

                let map;
                let course = null;
                let markers = [];
                let polylines = [];
                let originalCourse = null;
                let isInitialLoad = true; // Ï¥àÍ∏∞ Î°úÎìú Ïó¨Î∂Ä ÌîåÎûòÍ∑∏
                let selectedCoordinates = new Set(); // ÏÑ†ÌÉùÎêú Ï¢åÌëú (seg-idx_coord-idx ÌòïÏãù)
                let currentEditingCoord = null; // ÌòÑÏû¨ ÏàòÏ†ï Ï§ëÏù∏ Ï¢åÌëú {segIdx, coordIdx}

                // ÎßàÏª§ Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï
                let normalMarkerImage;
                let selectedMarkerImage;

                // ÌéòÏù¥ÏßÄ Ï¥àÍ∏∞Ìôî
                initializePage();

                async function initializePage() {
                    // Ïπ¥Ïπ¥Ïò§ Îßµ Ï¥àÍ∏∞Ìôî
                    const mapContainer = document.getElementById('map');
                    const mapOption = {
                        center: new kakao.maps.LatLng(37.5665, 126.9780),
                        level: 5
                    };

                    map = new kakao.maps.Map(mapContainer, mapOption);

                    // ÎßàÏª§ Ïù¥ÎØ∏ÏßÄ Ï¥àÍ∏∞Ìôî
                    const imageSize = new kakao.maps.Size(24, 35);
                    // normalMarkerImageÎäî null (Ïπ¥Ïπ¥Ïò§Îßµ Í∏∞Î≥∏ ÎßàÏª§ ÏÇ¨Ïö©)
                    normalMarkerImage = null;
                    // selectedMarkerImageÎäî Îπ®Í∞ÑÏÉâ ÎßàÏª§
                    selectedMarkerImage = new kakao.maps.MarkerImage(
                        'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png',
                        imageSize
                    );

                    // ÏΩîÏä§ Ï†ïÎ≥¥ Î°úÎìú
                    await loadCourse();
                }

                // Î©îÏãúÏßÄ ÌëúÏãú
                function showMessage(message, type = 'error') {
                    const messageContainer = document.getElementById('message-container');
                    const className = type === 'error' ? 'error-message' : 'success-message';
                    messageContainer.innerHTML = `<div class="${className}">${message}</div>`;
                    setTimeout(() => {
                        messageContainer.innerHTML = '';
                    }, 5000);
                }

                // ÏΩîÏä§ Ï†ïÎ≥¥ Î°úÎìú
                async function loadCourse() {
                    try {
                        const response = await axios.get(`/admin/courses/${courseId}`, {
                            withCredentials: true
                        });

                        console.log('API Response:', response.data);

                        if (response.data) {
                            course = response.data;
                            console.log('Course loaded:', course);
                            console.log('Segments:', course.segments);
                            originalCourse = JSON.parse(JSON.stringify(course)); // ÍπäÏùÄ Î≥µÏÇ¨
                            displayCourseInfo();
                            displayCoordinatesList();
                            drawCourseOnMap();
                        } else {
                            showMessage('ÏΩîÏä§Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                        }
                    } catch (error) {
                        console.error('ÏΩîÏä§ Î°úÎìú Ïã§Ìå®:', error);
                        if (error.response && error.response.status === 401) {
                            alert('Î°úÍ∑∏Ïù∏ ÏÑ∏ÏÖòÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§.');
                            window.location.href = '/admin/login';
                        } else if (error.response && error.response.status === 403) {
                            alert('Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§. Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                            window.location.href = '/admin/login';
                        } else {
                            showMessage('ÏΩîÏä§ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                        }
                    }
                }

                // ÏΩîÏä§ Ï†ïÎ≥¥ ÌëúÏãú
                function displayCourseInfo() {
                    try {
                        console.log('displayCourseInfo ÏãúÏûë');
                        const infoContainer = document.getElementById('course-info');

                        const totalCoordinates = course.segments.reduce((sum, segment) =>
                            sum + segment.coordinates.length, 0
                        );

                        let html = `
                            <div class="course-info">
                                <div class="info-item">
                                    <div class="info-label">ÏΩîÏä§ Ïù¥Î¶Ñ</div>
                                    <div class="info-value editable">
                                        <input type="text"
                                               id="course-name-input"
                                               class="info-input"
                                               value="${course.name}"
                                               onchange="updateCourseName(this.value)">
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">ÏΩîÏä§ Í∏∏Ïù¥</div>
                                    <div class="info-value">${(course.length / 1000).toFixed(2)} km</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">ÎèÑÎ°ú ÌÉÄÏûÖ</div>
                                    <div class="info-value editable">
                                        <select id="road-type-select"
                                                class="info-select"
                                                onchange="updateRoadType(this.value)">
                                            <option value="Ìä∏Îûô" ${course.roadType === 'Ìä∏Îûô' ? 'selected' : ''}>Ìä∏Îûô</option>
                                            <option value="Ìä∏Î†àÏùº" ${course.roadType === 'Ìä∏Î†àÏùº' ? 'selected' : ''}>Ìä∏Î†àÏùº</option>
                                            <option value="Î≥¥ÎèÑ" ${course.roadType === 'Î≥¥ÎèÑ' ? 'selected' : ''}>Î≥¥ÎèÑ</option>
                                            <option value="ÏïåÏàòÏóÜÏùå" ${course.roadType === 'ÏïåÏàòÏóÜÏùå' ? 'selected' : ''}>ÏïåÏàòÏóÜÏùå</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">ÎÇúÏù¥ÎèÑ</div>
                                    <div class="info-value">${course.difficulty}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Ï¥ù Ï¢åÌëú Ïàò</div>
                                    <div class="info-value">${totalCoordinates}Í∞ú</div>
                                </div>
                            </div>
                            <div class="segment-list">
                                <h3 style="margin-bottom: 15px; color: #2d3748;">ÏÑ∏Í∑∏Î®ºÌä∏ Î™©Î°ù</h3>
                        `;

                        course.segments.forEach((segment, index) => {
                            html += `
                                <div class="segment-item">
                                    <div class="segment-header">
                                        <span>ÏÑ∏Í∑∏Î®ºÌä∏ ${index + 1}</span>
                                        <span class="incline-badge ${segment.inclineType}">${segment.inclineType}</span>
                                    </div>
                                    <div class="coordinate-count">Ï¢åÌëú ${segment.coordinates.length}Í∞ú</div>
                                </div>
                            `;
                        });

                        html += '</div>';

                        infoContainer.innerHTML = html;
                        console.log('displayCourseInfo ÏôÑÎ£å');
                    } catch (error) {
                        console.error('displayCourseInfo ÏóêÎü¨:', error);
                        console.error('Error stack:', error.stack);
                        showMessage('ÏΩîÏä§ Ï†ïÎ≥¥ ÌëúÏãú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message, 'error');
                    }
                }

                // Ï¢åÌëú Î™©Î°ù ÌëúÏãú
                function displayCoordinatesList() {
                    try {
                        console.log('displayCoordinatesList ÏãúÏûë');
                        const coordinatesContainer = document.getElementById('coordinates-container');
                        coordinatesContainer.style.display = 'block';

                        let html = `
                            <div class="coordinates-header">
                                <div class="coordinates-title">Ï†ÑÏ≤¥ Ï¢åÌëú Î™©Î°ù</div>
                                <div class="bulk-actions">
                                    <button class="bulk-button secondary" onclick="showSelectedOnMap()" id="show-on-map-btn" disabled>
                                        ÏßÄÎèÑÏóêÏÑú Î≥¥Í∏∞
                                    </button>
                                    <button class="bulk-button primary" onclick="bulkEditCoordinates()" id="bulk-edit-btn" disabled>
                                        ÏùºÍ¥Ñ ÏàòÏ†ï
                                    </button>
                                </div>
                            </div>
                            <table class="coordinates-table">
                                <thead>
                                    <tr>
                                        <th>
                                            <label class="select-all-label">
                                                <input type="checkbox" class="coord-checkbox" id="select-all-checkbox" onchange="toggleAllCoordinates()">
                                                Ï†ÑÏ≤¥ ÏÑ†ÌÉù
                                            </label>
                                        </th>
                                        <th>Î≤àÌò∏</th>
                                        <th>ÏÑ∏Í∑∏Î®ºÌä∏</th>
                                        <th>ÏúÑÎèÑ</th>
                                        <th>Í≤ΩÎèÑ</th>
                                        <th>Í≥†ÎèÑ(m)</th>
                                        <th>Ìé∏Ïßë</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        let coordNumber = 1;
                        course.segments.forEach((segment, segIdx) => {
                            segment.coordinates.forEach((coord, coordIdx) => {
                                const coordId = `${segIdx}_${coordIdx}`;
                                const lat = (coord.latitude != null && !isNaN(coord.latitude)) ? Number(coord.latitude).toFixed(6) : 'N/A';
                                const lng = (coord.longitude != null && !isNaN(coord.longitude)) ? Number(coord.longitude).toFixed(6) : 'N/A';
                                const elev = (coord.elevation != null && !isNaN(coord.elevation)) ? Number(coord.elevation).toFixed(1) : 'N/A';

                                html += `
                                    <tr id="coord-row-${coordId}" class="${selectedCoordinates.has(coordId) ? 'selected' : ''}">
                                        <td>
                                            <input type="checkbox" class="coord-checkbox"
                                                   id="checkbox-${coordId}"
                                                   ${selectedCoordinates.has(coordId) ? 'checked' : ''}
                                                   onchange="toggleCoordinate(${segIdx}, ${coordIdx})">
                                        </td>
                                        <td class="coord-number">#${coordNumber}</td>
                                        <td>ÏÑ∏Í∑∏Î®ºÌä∏ ${segIdx + 1}</td>
                                        <td class="coord-value">${lat}</td>
                                        <td class="coord-value">${lng}</td>
                                        <td class="coord-value">${elev}</td>
                                        <td>
                                            <button class="coord-edit-btn" onclick="editSingleCoordinate(${segIdx}, ${coordIdx})">
                                                ÏàòÏ†ï
                                            </button>
                                        </td>
                                    </tr>
                                `;
                                coordNumber++;
                            });
                        });

                        html += `
                                </tbody>
                            </table>
                        `;

                        coordinatesContainer.innerHTML = html;
                        updateBulkActionButtons();
                        console.log('displayCoordinatesList ÏôÑÎ£å');
                    } catch (error) {
                        console.error('displayCoordinatesList ÏóêÎü¨:', error);
                        console.error('Error stack:', error.stack);
                        showMessage('Ï¢åÌëú Î™©Î°ù ÌëúÏãú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message, 'error');
                    }
                }

                // inclineTypeÏóê Îî∞Î•∏ ÏÉâÏÉÅ Î∞òÌôò
                function getColorByInclineType(inclineType) {
                    switch (inclineType) {
                        case 'UPHILL':
                            return '#FF0000';
                        case 'FLAT':
                            return '#00FF00';
                        case 'DOWNHILL':
                            return '#0000FF';
                        default:
                            return '#808080';
                    }
                }

                // ÏßÄÎèÑÏóê ÏΩîÏä§ Í∑∏Î¶¨Í∏∞
                function drawCourseOnMap() {
                    try {
                        console.log('drawCourseOnMap ÏãúÏûë');
                        console.log('course:', course);
                        console.log('map:', map);

                        // Í∏∞Ï°¥ ÎßàÏª§ÏôÄ Ìè¥Î¶¨ÎùºÏù∏ Ï†úÍ±∞
                        clearMap();

                        if (!course || !course.segments || course.segments.length === 0) {
                            console.log('ÏΩîÏä§ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå:', { course, segments: course?.segments });
                            return;
                        }

                        console.log('ÏÑ∏Í∑∏Î®ºÌä∏ Í∞úÏàò:', course.segments.length);

                        let allCoordinates = [];

                        // Í∞Å ÏÑ∏Í∑∏Î®ºÌä∏Î≥ÑÎ°ú Ìè¥Î¶¨ÎùºÏù∏ Í∑∏Î¶¨Í∏∞
                        course.segments.forEach((segment, segmentIndex) => {
                            console.log(`ÏÑ∏Í∑∏Î®ºÌä∏ ${segmentIndex}:`, segment);

                            if (!segment.coordinates || segment.coordinates.length === 0) {
                                console.log(`ÏÑ∏Í∑∏Î®ºÌä∏ ${segmentIndex} Ï¢åÌëú ÏóÜÏùå`);
                                return;
                            }

                            console.log(`ÏÑ∏Í∑∏Î®ºÌä∏ ${segmentIndex} Ï¢åÌëú Í∞úÏàò:`, segment.coordinates.length);

                            // Ï¢åÌëú Î∞∞Ïó¥ÏùÑ Ïπ¥Ïπ¥Ïò§Îßµ LatLng Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
                            const path = segment.coordinates.map(coord => {
                                console.log('Ï¢åÌëú:', coord);
                                return new kakao.maps.LatLng(coord.latitude, coord.longitude);
                            });

                            allCoordinates.push(...path);

                            // Ìè¥Î¶¨ÎùºÏù∏ ÏÉùÏÑ±
                            const polyline = new kakao.maps.Polyline({
                                path: path,
                                strokeWeight: 5,
                                strokeColor: getColorByInclineType(segment.inclineType),
                                strokeOpacity: 0.8,
                                strokeStyle: 'solid'
                            });

                            polyline.setMap(map);
                            polylines.push(polyline);
                            console.log(`ÏÑ∏Í∑∏Î®ºÌä∏ ${segmentIndex} Ìè¥Î¶¨ÎùºÏù∏ Ï∂îÍ∞ÄÎê®`);

                            // Í∞Å Ï¢åÌëúÏóê ÎìúÎûòÍ∑∏ Í∞ÄÎä•Ìïú ÎßàÏª§ Ï∂îÍ∞Ä
                            segment.coordinates.forEach((coord, coordIndex) => {
                                const position = new kakao.maps.LatLng(coord.latitude, coord.longitude);

                                const marker = new kakao.maps.Marker({
                                    position: position,
                                    draggable: true,
                                    map: map
                                    // imageÎ•º ÏÑ§Ï†ïÌïòÏßÄ ÏïäÏïÑ Ïπ¥Ïπ¥Ïò§Îßµ Í∏∞Î≥∏ ÎßàÏª§ ÏÇ¨Ïö©
                                });

                                // ÎßàÏª§ ÎìúÎûòÍ∑∏ Ïù¥Î≤§Ìä∏
                                kakao.maps.event.addListener(marker, 'dragend', function () {
                                    const newPosition = marker.getPosition();
                                    onMarkerDragEnd(segmentIndex, coordIndex, newPosition);
                                });

                                // ÎßàÏª§ Ïò§Î•∏Ï™Ω ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
                                kakao.maps.event.addListener(marker, 'rightclick', function () {
                                    openCoordinateModal(segmentIndex, coordIndex);
                                });

                                markers.push({
                                    marker: marker,
                                    segmentIndex: segmentIndex,
                                    coordIndex: coordIndex
                                });
                            });
                            console.log(`ÏÑ∏Í∑∏Î®ºÌä∏ ${segmentIndex} ÎßàÏª§ Ï∂îÍ∞ÄÎê®`);
                        });

                        console.log('Ï¥ù ÎßàÏª§ Í∞úÏàò:', markers.length);
                        console.log('Ï¥ù Ìè¥Î¶¨ÎùºÏù∏ Í∞úÏàò:', polylines.length);

                        // ÏßÄÎèÑ Ï§ëÏã¨ÏùÑ ÏΩîÏä§Ïóê ÎßûÏ∂îÍ∏∞ (Ï¥àÍ∏∞ Î°úÎìú ÏãúÏóêÎßå)
                        if (isInitialLoad && allCoordinates.length > 0) {
                            console.log('ÏßÄÎèÑ Ï§ëÏã¨ ÏÑ§Ï†ï Ï§ë...');
                            const bounds = new kakao.maps.LatLngBounds();
                            allCoordinates.forEach(coord => bounds.extend(coord));
                            map.setBounds(bounds);
                            isInitialLoad = false;
                            console.log('ÏßÄÎèÑ Ï§ëÏã¨ ÏÑ§Ï†ï ÏôÑÎ£å');
                        }

                        console.log('drawCourseOnMap ÏôÑÎ£å');
                    } catch (error) {
                        console.error('drawCourseOnMap ÏóêÎü¨:', error);
                        console.error('Error stack:', error.stack);
                        showMessage('ÏßÄÎèÑÏóê ÏΩîÏä§Î•º Í∑∏Î¶¨Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message, 'error');
                    }
                }

                // ÎßàÏª§ ÎìúÎûòÍ∑∏ Ï¢ÖÎ£å Ïãú Ï≤òÎ¶¨
                function onMarkerDragEnd(segmentIndex, coordIndex, newPosition) {
                    const segment = course.segments[segmentIndex];
                    const isFirstCoord = coordIndex === 0;
                    const isLastCoord = coordIndex === segment.coordinates.length - 1;

                    // ÌòÑÏû¨ Ï¢åÌëú ÏóÖÎç∞Ïù¥Ìä∏
                    segment.coordinates[coordIndex].latitude = newPosition.getLat();
                    segment.coordinates[coordIndex].longitude = newPosition.getLng();

                    // ÏóÖÎç∞Ïù¥Ìä∏Ìï† ÏÑ∏Í∑∏Î®ºÌä∏ Ïù∏Îç±Ïä§ ÏàòÏßë
                    const segmentsToUpdate = [segmentIndex];
                    const markersToUpdate = [];

                    // ÏÑ∏Í∑∏Î®ºÌä∏ Í≤ΩÍ≥Ñ Ï¢åÌëúÏù∏ Í≤ΩÏö∞ Ïù∏Ï†ë ÏÑ∏Í∑∏Î®ºÌä∏ÏôÄ ÎßàÏª§ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                    if (isFirstCoord && segmentIndex > 0) {
                        // Ï≤´ Î≤àÏß∏ Ï¢åÌëúÏù¥Í≥† Ïù¥Ï†Ñ ÏÑ∏Í∑∏Î®ºÌä∏Í∞Ä ÏûàÎäî Í≤ΩÏö∞
                        const prevSegment = course.segments[segmentIndex - 1];
                        const prevLastIndex = prevSegment.coordinates.length - 1;
                        prevSegment.coordinates[prevLastIndex].latitude = newPosition.getLat();
                        prevSegment.coordinates[prevLastIndex].longitude = newPosition.getLng();
                        segmentsToUpdate.push(segmentIndex - 1);

                        // Ïù¥Ï†Ñ ÏÑ∏Í∑∏Î®ºÌä∏Ïùò ÎßàÏßÄÎßâ ÎßàÏª§ Ï∞æÏïÑÏÑú ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
                        const prevMarkerInfo = markers.find(m =>
                            m.segmentIndex === segmentIndex - 1 &&
                            m.coordIndex === prevLastIndex
                        );
                        if (prevMarkerInfo) {
                            prevMarkerInfo.marker.setPosition(newPosition);
                        }
                    }

                    if (isLastCoord && segmentIndex < course.segments.length - 1) {
                        // ÎßàÏßÄÎßâ Ï¢åÌëúÏù¥Í≥† Îã§Ïùå ÏÑ∏Í∑∏Î®ºÌä∏Í∞Ä ÏûàÎäî Í≤ΩÏö∞
                        const nextSegment = course.segments[segmentIndex + 1];
                        nextSegment.coordinates[0].latitude = newPosition.getLat();
                        nextSegment.coordinates[0].longitude = newPosition.getLng();
                        segmentsToUpdate.push(segmentIndex + 1);

                        // Îã§Ïùå ÏÑ∏Í∑∏Î®ºÌä∏Ïùò Ï≤´ Î≤àÏß∏ ÎßàÏª§ Ï∞æÏïÑÏÑú ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
                        const nextMarkerInfo = markers.find(m =>
                            m.segmentIndex === segmentIndex + 1 &&
                            m.coordIndex === 0
                        );
                        if (nextMarkerInfo) {
                            nextMarkerInfo.marker.setPosition(newPosition);
                        }
                    }

                    // ÏòÅÌñ•Î∞õÏùÄ ÏÑ∏Í∑∏Î®ºÌä∏Ïùò Ìè¥Î¶¨ÎùºÏù∏Îßå ÏóÖÎç∞Ïù¥Ìä∏
                    updateSegmentPolylines(segmentsToUpdate);

                    // Î≥ÄÍ≤Ω ÏïåÎ¶º
                    let message = 'Ï¢åÌëúÍ∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.';
                    if (isFirstCoord && segmentIndex > 0) {
                        message += ' (Ïù¥Ï†Ñ ÏÑ∏Í∑∏Î®ºÌä∏ÏôÄ Ïó∞Í≤∞Îê®)';
                    } else if (isLastCoord && segmentIndex < course.segments.length - 1) {
                        message += ' (Îã§Ïùå ÏÑ∏Í∑∏Î®ºÌä∏ÏôÄ Ïó∞Í≤∞Îê®)';
                    }
                    message += ' (ÏûêÎèô Ï†ÄÏû• Í∏∞Îä•ÏùÄ Ï∂îÌõÑ Íµ¨ÌòÑ ÏòàÏ†ï)';
                    showMessage(message, 'success');
                    console.log('Updated course:', course);
                }

                // ÌäπÏ†ï ÏÑ∏Í∑∏Î®ºÌä∏Îì§Ïùò Ìè¥Î¶¨ÎùºÏù∏Îßå ÏóÖÎç∞Ïù¥Ìä∏
                function updateSegmentPolylines(segmentIndices) {
                    segmentIndices.forEach(segmentIndex => {
                        const segment = course.segments[segmentIndex];
                        if (!segment || !segment.coordinates || segment.coordinates.length === 0) {
                            return;
                        }

                        // Í∏∞Ï°¥ Ìè¥Î¶¨ÎùºÏù∏ Ï†úÍ±∞ (Ìï¥Îãπ ÏÑ∏Í∑∏Î®ºÌä∏Îßå)
                        const oldPolyline = polylines[segmentIndex];
                        if (oldPolyline) {
                            oldPolyline.setMap(null);
                        }

                        // ÏÉà Í≤ΩÎ°úÎ°ú Ìè¥Î¶¨ÎùºÏù∏ ÏÉùÏÑ±
                        const path = segment.coordinates.map(coord =>
                            new kakao.maps.LatLng(coord.latitude, coord.longitude)
                        );

                        const newPolyline = new kakao.maps.Polyline({
                            path: path,
                            strokeWeight: 5,
                            strokeColor: getColorByInclineType(segment.inclineType),
                            strokeOpacity: 0.8,
                            strokeStyle: 'solid'
                        });

                        newPolyline.setMap(map);
                        polylines[segmentIndex] = newPolyline;
                    });
                }

                // Î™®Îì† Ìè¥Î¶¨ÎùºÏù∏ ÏóÖÎç∞Ïù¥Ìä∏
                function updatePolylines() {
                    // Í∏∞Ï°¥ Ìè¥Î¶¨ÎùºÏù∏ Ï†úÍ±∞
                    polylines.forEach(polyline => polyline.setMap(null));
                    polylines = [];

                    // Ìè¥Î¶¨ÎùºÏù∏ Îã§Ïãú Í∑∏Î¶¨Í∏∞
                    course.segments.forEach(segment => {
                        if (!segment.coordinates || segment.coordinates.length === 0) {
                            return;
                        }

                        const path = segment.coordinates.map(coord =>
                            new kakao.maps.LatLng(coord.latitude, coord.longitude)
                        );

                        const polyline = new kakao.maps.Polyline({
                            path: path,
                            strokeWeight: 5,
                            strokeColor: getColorByInclineType(segment.inclineType),
                            strokeOpacity: 0.8,
                            strokeStyle: 'solid'
                        });

                        polyline.setMap(map);
                        polylines.push(polyline);
                    });
                }

                // ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî
                function clearMap() {
                    markers.forEach(item => item.marker.setMap(null));
                    markers = [];
                    polylines.forEach(polyline => polyline.setMap(null));
                    polylines = [];
                }

                // Î≥ÄÍ≤ΩÏÇ¨Ìï≠ Ï¥àÍ∏∞Ìôî
                function resetChanges() {
                    if (confirm('Î™®Îì† Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏùÑ Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                        course = JSON.parse(JSON.stringify(originalCourse));
                        displayCourseInfo();
                        displayCoordinatesList();
                        drawCourseOnMap();
                        showMessage('Î≥ÄÍ≤ΩÏÇ¨Ìï≠Ïù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.', 'success');
                    }
                }

                // Ï¢åÌëú ÏÑ†ÌÉù/Ìï¥Ï†ú
                function toggleCoordinate(segIdx, coordIdx) {
                    const coordId = `${segIdx}_${coordIdx}`;
                    const row = document.getElementById(`coord-row-${coordId}`);
                    const checkbox = document.getElementById(`checkbox-${coordId}`);

                    // ÎßàÏª§ Ï∞æÍ∏∞
                    const markerInfo = markers.find(m =>
                        m.segmentIndex === segIdx && m.coordIndex === coordIdx
                    );

                    if (checkbox.checked) {
                        selectedCoordinates.add(coordId);
                        row.classList.add('selected');
                        // ÎßàÏª§ Ïù¥ÎØ∏ÏßÄÎ•º ÏÑ†ÌÉù Ïù¥ÎØ∏ÏßÄÎ°ú Î≥ÄÍ≤Ω
                        if (markerInfo && selectedMarkerImage) {
                            markerInfo.marker.setImage(selectedMarkerImage);
                            markerInfo.marker.setZIndex(1000);
                        }
                    } else {
                        selectedCoordinates.delete(coordId);
                        row.classList.remove('selected');
                        // ÎßàÏª§ Ïù¥ÎØ∏ÏßÄÎ•º Í∏∞Î≥∏ Ïù¥ÎØ∏ÏßÄÎ°ú Î≥ÄÍ≤Ω
                        if (markerInfo) {
                            if (normalMarkerImage) {
                                markerInfo.marker.setImage(normalMarkerImage);
                            } else {
                                // normalMarkerImageÍ∞Ä nullÏù¥Î©¥ Í∏∞Î≥∏ ÎßàÏª§Î°ú Î≥µÏõê
                                markerInfo.marker.setImage(null);
                            }
                            markerInfo.marker.setZIndex(1);
                        }
                    }

                    updateBulkActionButtons();
                    updateSelectAllCheckbox();
                }

                // Ï†ÑÏ≤¥ ÏÑ†ÌÉù/Ìï¥Ï†ú
                function toggleAllCoordinates() {
                    const selectAllCheckbox = document.getElementById('select-all-checkbox');
                    const isChecked = selectAllCheckbox.checked;

                    course.segments.forEach((segment, segIdx) => {
                        segment.coordinates.forEach((coord, coordIdx) => {
                            const coordId = `${segIdx}_${coordIdx}`;
                            const row = document.getElementById(`coord-row-${coordId}`);
                            const checkbox = document.getElementById(`checkbox-${coordId}`);

                            // ÎßàÏª§ Ï∞æÍ∏∞
                            const markerInfo = markers.find(m =>
                                m.segmentIndex === segIdx && m.coordIndex === coordIdx
                            );

                            if (checkbox) {
                                checkbox.checked = isChecked;
                                if (isChecked) {
                                    selectedCoordinates.add(coordId);
                                    row.classList.add('selected');
                                    // ÎßàÏª§ Ïù¥ÎØ∏ÏßÄÎ•º ÏÑ†ÌÉù Ïù¥ÎØ∏ÏßÄÎ°ú Î≥ÄÍ≤Ω
                                    if (markerInfo && selectedMarkerImage) {
                                        markerInfo.marker.setImage(selectedMarkerImage);
                                        markerInfo.marker.setZIndex(1000);
                                    }
                                } else {
                                    selectedCoordinates.delete(coordId);
                                    row.classList.remove('selected');
                                    // ÎßàÏª§ Ïù¥ÎØ∏ÏßÄÎ•º Í∏∞Î≥∏ Ïù¥ÎØ∏ÏßÄÎ°ú Î≥ÄÍ≤Ω
                                    if (markerInfo) {
                                        if (normalMarkerImage) {
                                            markerInfo.marker.setImage(normalMarkerImage);
                                        } else {
                                            // normalMarkerImageÍ∞Ä nullÏù¥Î©¥ Í∏∞Î≥∏ ÎßàÏª§Î°ú Î≥µÏõê
                                            markerInfo.marker.setImage(null);
                                        }
                                        markerInfo.marker.setZIndex(1);
                                    }
                                }
                            }
                        });
                    });

                    updateBulkActionButtons();
                }

                // Ï†ÑÏ≤¥ ÏÑ†ÌÉù Ï≤¥ÌÅ¨Î∞ïÏä§ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                function updateSelectAllCheckbox() {
                    const selectAllCheckbox = document.getElementById('select-all-checkbox');
                    if (!selectAllCheckbox) return;

                    const totalCoordinates = course.segments.reduce((sum, segment) =>
                        sum + segment.coordinates.length, 0
                    );

                    if (selectedCoordinates.size === 0) {
                        selectAllCheckbox.checked = false;
                        selectAllCheckbox.indeterminate = false;
                    } else if (selectedCoordinates.size === totalCoordinates) {
                        selectAllCheckbox.checked = true;
                        selectAllCheckbox.indeterminate = false;
                    } else {
                        selectAllCheckbox.checked = false;
                        selectAllCheckbox.indeterminate = true;
                    }
                }

                // ÏùºÍ¥Ñ ÏàòÏ†ï Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                function updateBulkActionButtons() {
                    const showOnMapBtn = document.getElementById('show-on-map-btn');
                    const bulkEditBtn = document.getElementById('bulk-edit-btn');

                    const hasSelection = selectedCoordinates.size > 0;

                    if (showOnMapBtn) {
                        showOnMapBtn.disabled = !hasSelection;
                    }
                    if (bulkEditBtn) {
                        bulkEditBtn.disabled = !hasSelection;
                    }
                }

                // ÏÑ†ÌÉùÎêú Ï¢åÌëú ÏßÄÎèÑÏóê ÌëúÏãú
                function showSelectedOnMap() {
                    if (selectedCoordinates.size === 0) {
                        showMessage('ÏÑ†ÌÉùÎêú Ï¢åÌëúÍ∞Ä ÏóÜÏäµÎãàÎã§.', 'error');
                        return;
                    }

                    // Î™®Îì† ÎßàÏª§Ïùò zIndexÎ•º Í∏∞Î≥∏Í∞íÏúºÎ°ú ÏÑ§Ï†ï
                    markers.forEach(item => {
                        item.marker.setZIndex(1);
                    });

                    // ÏÑ†ÌÉùÎêú Ï¢åÌëúÏùò ÎßàÏª§Îßå Í∞ïÏ°∞
                    const selectedBounds = new kakao.maps.LatLngBounds();
                    let selectedCount = 0;

                    selectedCoordinates.forEach(coordId => {
                        const [segIdx, coordIdx] = coordId.split('_').map(Number);
                        const markerInfo = markers.find(m =>
                            m.segmentIndex === segIdx && m.coordIndex === coordIdx
                        );

                        if (markerInfo) {
                            markerInfo.marker.setZIndex(1000);
                            const position = markerInfo.marker.getPosition();
                            selectedBounds.extend(position);
                            selectedCount++;
                        }
                    });

                    if (selectedCount > 0) {
                        map.setBounds(selectedBounds);
                        showMessage(`${selectedCount}Í∞úÏùò ÏÑ†ÌÉùÎêú Ï¢åÌëúÍ∞Ä Í∞ïÏ°∞ÎêòÏóàÏäµÎãàÎã§.`, 'success');
                    }
                }

                // Îã®Ïùº Ï¢åÌëú ÏàòÏ†ï
                function editSingleCoordinate(segIdx, coordIdx) {
                    const coord = course.segments[segIdx].coordinates[coordIdx];

                    const latitude = prompt('ÏúÑÎèÑÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', coord.latitude.toFixed(6));
                    if (latitude === null) return;

                    const longitude = prompt('Í≤ΩÎèÑÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', coord.longitude.toFixed(6));
                    if (longitude === null) return;

                    const elevation = prompt('Í≥†ÎèÑ(m)Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', coord.elevation.toFixed(1));
                    if (elevation === null) return;

                    const newLat = parseFloat(latitude);
                    const newLng = parseFloat(longitude);
                    const newElev = parseFloat(elevation);

                    // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                    if (isNaN(newLat) || isNaN(newLng) || isNaN(newElev)) {
                        showMessage('ÏûòÎ™ªÎêú ÏûÖÎ†•ÏûÖÎãàÎã§. Ïà´ÏûêÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                        return;
                    }

                    if (newLat < -90 || newLat > 90) {
                        showMessage('ÏúÑÎèÑÎäî -90 ~ 90 ÏÇ¨Ïù¥Ïùò Í∞íÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.', 'error');
                        return;
                    }

                    if (newLng < -180 || newLng > 180) {
                        showMessage('Í≤ΩÎèÑÎäî -180 ~ 180 ÏÇ¨Ïù¥Ïùò Í∞íÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.', 'error');
                        return;
                    }

                    // Ï¢åÌëú ÏóÖÎç∞Ïù¥Ìä∏
                    coord.latitude = newLat;
                    coord.longitude = newLng;
                    coord.elevation = newElev;

                    // ÏÑ∏Í∑∏Î®ºÌä∏ Í≤ΩÍ≥Ñ Ï¢åÌëúÏù∏ Í≤ΩÏö∞ Ïù∏Ï†ë ÏÑ∏Í∑∏Î®ºÌä∏ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                    const segment = course.segments[segIdx];
                    const isFirstCoord = coordIdx === 0;
                    const isLastCoord = coordIdx === segment.coordinates.length - 1;
                    const segmentsToUpdate = [segIdx];

                    if (isFirstCoord && segIdx > 0) {
                        const prevSegment = course.segments[segIdx - 1];
                        const prevLastIndex = prevSegment.coordinates.length - 1;
                        prevSegment.coordinates[prevLastIndex].latitude = newLat;
                        prevSegment.coordinates[prevLastIndex].longitude = newLng;
                        prevSegment.coordinates[prevLastIndex].elevation = newElev;
                        segmentsToUpdate.push(segIdx - 1);
                    }

                    if (isLastCoord && segIdx < course.segments.length - 1) {
                        const nextSegment = course.segments[segIdx + 1];
                        nextSegment.coordinates[0].latitude = newLat;
                        nextSegment.coordinates[0].longitude = newLng;
                        nextSegment.coordinates[0].elevation = newElev;
                        segmentsToUpdate.push(segIdx + 1);
                    }

                    // ÏßÄÎèÑÏùò ÎßàÏª§ ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
                    const newPosition = new kakao.maps.LatLng(newLat, newLng);
                    const markerInfo = markers.find(m =>
                        m.segmentIndex === segIdx && m.coordIndex === coordIdx
                    );
                    if (markerInfo) {
                        markerInfo.marker.setPosition(newPosition);
                    }

                    // Ïù∏Ï†ë ÎßàÏª§Îì§ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                    if (isFirstCoord && segIdx > 0) {
                        const prevSegment = course.segments[segIdx - 1];
                        const prevLastIndex = prevSegment.coordinates.length - 1;
                        const prevMarkerInfo = markers.find(m =>
                            m.segmentIndex === segIdx - 1 && m.coordIndex === prevLastIndex
                        );
                        if (prevMarkerInfo) {
                            prevMarkerInfo.marker.setPosition(newPosition);
                        }
                    }

                    if (isLastCoord && segIdx < course.segments.length - 1) {
                        const nextMarkerInfo = markers.find(m =>
                            m.segmentIndex === segIdx + 1 && m.coordIndex === 0
                        );
                        if (nextMarkerInfo) {
                            nextMarkerInfo.marker.setPosition(newPosition);
                        }
                    }

                    // Ìè¥Î¶¨ÎùºÏù∏ ÏóÖÎç∞Ïù¥Ìä∏
                    updateSegmentPolylines(segmentsToUpdate);

                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    displayCoordinatesList();
                    showMessage('Ï¢åÌëúÍ∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.', 'success');
                }

                // ÏùºÍ¥Ñ ÏàòÏ†ï
                function bulkEditCoordinates() {
                    if (selectedCoordinates.size === 0) {
                        showMessage('ÏÑ†ÌÉùÎêú Ï¢åÌëúÍ∞Ä ÏóÜÏäµÎãàÎã§.', 'error');
                        return;
                    }

                    const elevationOffset = prompt(`${selectedCoordinates.size}Í∞úÏùò ÏÑ†ÌÉùÎêú Ï¢åÌëúÏùò Í≥†ÎèÑÎ•º ÏùºÍ¥Ñ ÏàòÏ†ïÌï©ÎãàÎã§.\\nÍ≥†ÎèÑ Î≥ÄÍ≤ΩÍ∞í(m)ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: +10, -5):`, '+0');
                    if (elevationOffset === null) return;

                    const offset = parseFloat(elevationOffset);
                    if (isNaN(offset)) {
                        showMessage('ÏûòÎ™ªÎêú ÏûÖÎ†•ÏûÖÎãàÎã§. Ïà´ÏûêÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                        return;
                    }

                    // ÏÑ†ÌÉùÎêú Ï¢åÌëúÎì§Ïùò Í≥†ÎèÑ ÏùºÍ¥Ñ ÏàòÏ†ï
                    const updatedSegments = new Set();
                    selectedCoordinates.forEach(coordId => {
                        const [segIdx, coordIdx] = coordId.split('_').map(Number);
                        const coord = course.segments[segIdx].coordinates[coordIdx];
                        coord.elevation += offset;
                        updatedSegments.add(segIdx);

                        // ÏÑ∏Í∑∏Î®ºÌä∏ Í≤ΩÍ≥Ñ Ï¢åÌëúÏù∏ Í≤ΩÏö∞ Ïù∏Ï†ë ÏÑ∏Í∑∏Î®ºÌä∏ÎèÑ Ï≤¥ÌÅ¨
                        const segment = course.segments[segIdx];
                        const isFirstCoord = coordIdx === 0;
                        const isLastCoord = coordIdx === segment.coordinates.length - 1;

                        if (isFirstCoord && segIdx > 0) {
                            const prevSegment = course.segments[segIdx - 1];
                            const prevLastIndex = prevSegment.coordinates.length - 1;
                            prevSegment.coordinates[prevLastIndex].elevation = coord.elevation;
                            updatedSegments.add(segIdx - 1);
                        }

                        if (isLastCoord && segIdx < course.segments.length - 1) {
                            const nextSegment = course.segments[segIdx + 1];
                            nextSegment.coordinates[0].elevation = coord.elevation;
                            updatedSegments.add(segIdx + 1);
                        }
                    });

                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    displayCoordinatesList();
                    showMessage(`${selectedCoordinates.size}Í∞ú Ï¢åÌëúÏùò Í≥†ÎèÑÍ∞Ä ${offset > 0 ? '+' : ''}${offset}m Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`, 'success');
                }

                // ÏΩîÏä§ Ïù¥Î¶Ñ ÏóÖÎç∞Ïù¥Ìä∏
                function updateCourseName(newName) {
                    if (!course) {
                        showMessage('ÏΩîÏä§ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                        return;
                    }

                    // Îπà Î¨∏ÏûêÏó¥ Ï≤¥ÌÅ¨
                    if (!newName.trim()) {
                        showMessage('ÏΩîÏä§ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                        // Ïù¥Ï†Ñ Í∞íÏúºÎ°ú Î≥µÏõê
                        const nameInput = document.getElementById('course-name-input');
                        if (nameInput) {
                            nameInput.value = course.name;
                        }
                        return;
                    }

                    // ÏΩîÏä§ Ïù¥Î¶Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    course.name = newName.trim();
                    showMessage('ÏΩîÏä§ Ïù¥Î¶ÑÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.', 'success');
                    console.log('ÏΩîÏä§ Ïù¥Î¶Ñ Î≥ÄÍ≤Ω:', course.name);
                }

                // ÎèÑÎ°ú ÌÉÄÏûÖ ÏóÖÎç∞Ïù¥Ìä∏
                function updateRoadType(newRoadType) {
                    if (!course) {
                        showMessage('ÏΩîÏä§ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.', 'error');
                        return;
                    }

                    // Ïú†Ìö®Ìïú ÎèÑÎ°ú ÌÉÄÏûÖÏù∏ÏßÄ ÌôïÏù∏
                    const validRoadTypes = ['Ìä∏Îûô', 'Ìä∏Î†àÏùº', 'Î≥¥ÎèÑ', 'ÏïåÏàòÏóÜÏùå'];
                    if (!validRoadTypes.includes(newRoadType)) {
                        showMessage('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÎèÑÎ°ú ÌÉÄÏûÖÏûÖÎãàÎã§.', 'error');
                        // Ïù¥Ï†Ñ Í∞íÏúºÎ°ú Î≥µÏõê
                        const roadTypeSelect = document.getElementById('road-type-select');
                        if (roadTypeSelect) {
                            roadTypeSelect.value = course.roadType;
                        }
                        return;
                    }

                    // ÎèÑÎ°ú ÌÉÄÏûÖ ÏóÖÎç∞Ïù¥Ìä∏
                    course.roadType = newRoadType;
                    showMessage('ÎèÑÎ°ú ÌÉÄÏûÖÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.', 'success');
                    console.log('ÎèÑÎ°ú ÌÉÄÏûÖ Î≥ÄÍ≤Ω:', course.roadType);
                }

                // ÏΩîÏä§ Ï†ÄÏû•
                async function saveCourse() {
                    if (!course) {
                        showMessage('Ï†ÄÏû•Ìï† ÏΩîÏä§Í∞Ä ÏóÜÏäµÎãàÎã§.', 'error');
                        return;
                    }

                    if (!confirm('Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏùÑ Ï†ÄÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                        return;
                    }

                    // Ï†ÄÏû• Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
                    const saveButton = document.querySelector('.save-button');
                    if (saveButton) {
                        saveButton.disabled = true;
                        saveButton.textContent = 'Ï†ÄÏû• Ï§ë...';
                    }

                    try {
                        console.log('=== Ï†ÄÏû•Ìï† ÏΩîÏä§ Îç∞Ïù¥ÌÑ∞ ===');
                        console.log('Course ID:', courseId);
                        console.log('Course Data:', JSON.stringify(course, null, 2));

                        // Î™®Îì† ÏÑ∏Í∑∏Î®ºÌä∏Ïùò Ï¢åÌëúÎ•º ÌèâÌÉÑÌôîÌïòÏó¨ [[lat, lng, elev], ...] ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
                        const coordinates = [];
                        course.segments.forEach(segment => {
                            segment.coordinates.forEach(coord => {
                                coordinates.push([
                                    coord.latitude,
                                    coord.longitude,
                                    coord.elevation
                                ]);
                            });
                        });

                        // API ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
                        const requestData = {
                            coordinates: coordinates,
                            name: course.name,
                            roadType: course.roadType
                        };

                        console.log('=== API ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞ ===');
                        console.log('Request Data:', JSON.stringify(requestData, null, 2));

                        // API Ìò∏Ï∂ú
                        const response = await axios.patch(`/admin/courses/${courseId}`, requestData, {
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            withCredentials: true
                        });

                        if (response.status === 200) {
                            // Ï†ÄÏû• ÏÑ±Í≥µ Ïãú originalCourse ÏóÖÎç∞Ïù¥Ìä∏
                            originalCourse = JSON.parse(JSON.stringify(course));
                            showMessage('ÏΩîÏä§Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.', 'success');
                            console.log('ÏΩîÏä§ Ï†ÄÏû• ÏÑ±Í≥µ');
                        }

                    } catch (error) {
                        console.error('ÏΩîÏä§ Ï†ÄÏû• Ïã§Ìå®:', error);
                        if (error.response && error.response.status === 401) {
                            alert('Î°úÍ∑∏Ïù∏ ÏÑ∏ÏÖòÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§.');
                            window.location.href = '/admin/login';
                        } else if (error.response && error.response.status === 403) {
                            alert('Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§. Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                            window.location.href = '/admin/login';
                        } else {
                            const errorMessage = error.response?.data?.message || error.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò';
                            showMessage('ÏΩîÏä§ Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + errorMessage, 'error');
                        }
                    } finally {
                        // Ï†ÄÏû• Î≤ÑÌäº ÌôúÏÑ±Ìôî
                        if (saveButton) {
                            saveButton.disabled = false;
                            saveButton.textContent = 'Ï†ÄÏû•';
                        }
                    }
                }

                // Ï¢åÌëú ÏàòÏ†ï Î™®Îã¨ Ïó¥Í∏∞
                function openCoordinateModal(segIdx, coordIdx) {
                    const coord = course.segments[segIdx].coordinates[coordIdx];

                    // ÌòÑÏû¨ ÏàòÏ†ï Ï§ëÏù∏ Ï¢åÌëú Ï†ïÎ≥¥ Ï†ÄÏû•
                    currentEditingCoord = { segIdx, coordIdx };

                    // Î™®Îã¨ ÏûÖÎ†• ÌïÑÎìúÏóê ÌòÑÏû¨ Í∞í ÏÑ§Ï†ï
                    document.getElementById('modal-latitude').value = coord.latitude.toFixed(6);
                    document.getElementById('modal-longitude').value = coord.longitude.toFixed(6);
                    document.getElementById('modal-elevation').value = coord.elevation.toFixed(1);

                    // Î™®Îã¨ ÌëúÏãú
                    const modal = document.getElementById('coordinate-edit-modal');
                    modal.classList.add('active');

                    // Ï≤´ Î≤àÏß∏ ÏûÖÎ†• ÌïÑÎìúÏóê Ìè¨Ïª§Ïä§
                    setTimeout(() => {
                        document.getElementById('modal-latitude').focus();
                    }, 100);
                }

                // Ï¢åÌëú ÏàòÏ†ï Î™®Îã¨ Îã´Í∏∞
                function closeCoordinateModal() {
                    const modal = document.getElementById('coordinate-edit-modal');
                    modal.classList.remove('active');
                    currentEditingCoord = null;
                }

                // Î™®Îã¨ÏóêÏÑú Ï¢åÌëú Ï†ÄÏû•
                function saveCoordinateFromModal() {
                    if (!currentEditingCoord) {
                        showMessage('ÏàòÏ†ïÌï† Ï¢åÌëú Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.', 'error');
                        return;
                    }

                    const { segIdx, coordIdx } = currentEditingCoord;

                    // ÏûÖÎ†•Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
                    const newLat = parseFloat(document.getElementById('modal-latitude').value);
                    const newLng = parseFloat(document.getElementById('modal-longitude').value);
                    const newElev = parseFloat(document.getElementById('modal-elevation').value);

                    // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                    if (isNaN(newLat) || isNaN(newLng) || isNaN(newElev)) {
                        showMessage('ÏûòÎ™ªÎêú ÏûÖÎ†•ÏûÖÎãàÎã§. Ïà´ÏûêÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                        return;
                    }

                    if (newLat < -90 || newLat > 90) {
                        showMessage('ÏúÑÎèÑÎäî -90 ~ 90 ÏÇ¨Ïù¥Ïùò Í∞íÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.', 'error');
                        return;
                    }

                    if (newLng < -180 || newLng > 180) {
                        showMessage('Í≤ΩÎèÑÎäî -180 ~ 180 ÏÇ¨Ïù¥Ïùò Í∞íÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.', 'error');
                        return;
                    }

                    // Ï¢åÌëú ÏóÖÎç∞Ïù¥Ìä∏
                    const coord = course.segments[segIdx].coordinates[coordIdx];
                    coord.latitude = newLat;
                    coord.longitude = newLng;
                    coord.elevation = newElev;

                    // ÏÑ∏Í∑∏Î®ºÌä∏ Í≤ΩÍ≥Ñ Ï¢åÌëúÏù∏ Í≤ΩÏö∞ Ïù∏Ï†ë ÏÑ∏Í∑∏Î®ºÌä∏ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                    const segment = course.segments[segIdx];
                    const isFirstCoord = coordIdx === 0;
                    const isLastCoord = coordIdx === segment.coordinates.length - 1;
                    const segmentsToUpdate = [segIdx];

                    if (isFirstCoord && segIdx > 0) {
                        const prevSegment = course.segments[segIdx - 1];
                        const prevLastIndex = prevSegment.coordinates.length - 1;
                        prevSegment.coordinates[prevLastIndex].latitude = newLat;
                        prevSegment.coordinates[prevLastIndex].longitude = newLng;
                        prevSegment.coordinates[prevLastIndex].elevation = newElev;
                        segmentsToUpdate.push(segIdx - 1);
                    }

                    if (isLastCoord && segIdx < course.segments.length - 1) {
                        const nextSegment = course.segments[segIdx + 1];
                        nextSegment.coordinates[0].latitude = newLat;
                        nextSegment.coordinates[0].longitude = newLng;
                        nextSegment.coordinates[0].elevation = newElev;
                        segmentsToUpdate.push(segIdx + 1);
                    }

                    // ÏßÄÎèÑÏùò ÎßàÏª§ ÏúÑÏπò ÏóÖÎç∞Ïù¥Ìä∏
                    const newPosition = new kakao.maps.LatLng(newLat, newLng);
                    const markerInfo = markers.find(m =>
                        m.segmentIndex === segIdx && m.coordIndex === coordIdx
                    );
                    if (markerInfo) {
                        markerInfo.marker.setPosition(newPosition);
                    }

                    // Ïù∏Ï†ë ÎßàÏª§Îì§ÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                    if (isFirstCoord && segIdx > 0) {
                        const prevSegment = course.segments[segIdx - 1];
                        const prevLastIndex = prevSegment.coordinates.length - 1;
                        const prevMarkerInfo = markers.find(m =>
                            m.segmentIndex === segIdx - 1 && m.coordIndex === prevLastIndex
                        );
                        if (prevMarkerInfo) {
                            prevMarkerInfo.marker.setPosition(newPosition);
                        }
                    }

                    if (isLastCoord && segIdx < course.segments.length - 1) {
                        const nextMarkerInfo = markers.find(m =>
                            m.segmentIndex === segIdx + 1 && m.coordIndex === 0
                        );
                        if (nextMarkerInfo) {
                            nextMarkerInfo.marker.setPosition(newPosition);
                        }
                    }

                    // Ìè¥Î¶¨ÎùºÏù∏ ÏóÖÎç∞Ïù¥Ìä∏
                    updateSegmentPolylines(segmentsToUpdate);

                    // UI ÏóÖÎç∞Ïù¥Ìä∏
                    displayCoordinatesList();
                    showMessage('Ï¢åÌëúÍ∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.', 'success');

                    // Î™®Îã¨ Îã´Í∏∞
                    closeCoordinateModal();
                }

                // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
                document.getElementById('coordinate-edit-modal').addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeCoordinateModal();
                    }
                });

                // ESC ÌÇ§Î°ú Î™®Îã¨ Îã´Í∏∞
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        const modal = document.getElementById('coordinate-edit-modal');
                        if (modal.classList.contains('active')) {
                            closeCoordinateModal();
                        }
                    }
                });

                // Enter ÌÇ§Î°ú Î™®Îã¨ Ï†ÄÏû•
                document.getElementById('coordinate-edit-modal').addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && this.classList.contains('active')) {
                        e.preventDefault();
                        saveCoordinateFromModal();
                    }
                });
            </script>
            </body>
            </html>
            """;

}
