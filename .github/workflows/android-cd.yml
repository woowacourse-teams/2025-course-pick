name: Android CD (Deploy to PlayStore directly)

on:
  # Github Action íƒ­ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      updatePriority:
        description: 'ì—…ë°ì´íŠ¸ ìš°ì„ ìˆœìœ„ (1-5). 5ëŠ” ì¦‰ì‹œ ì—…ë°ì´íŠ¸.'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Jobì— ê¶Œí•œì„ ë¶€ì—¬í•˜ì—¬ Google Cloud ì¸ì¦ í† í°ì„ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      # ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # JDK 21 ì„¤ì •
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # Gradle ìºì‹œ ì„¤ì •
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # google-services.json íŒŒì¼ ë””ì½”ë”©
      - name: Decode google-services.json
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 -d > android/app/google-services.json

      # Keystore íŒŒì¼ ë””ì½”ë”©
      - name: Decode Keystore
        run: echo "${{ secrets.SIGNING_KEYSTORE_BASE64 }}" | base64 -d > android/app/keystore.jks

      # Release AAB ë¹Œë“œ
      - name: Build Release AAB
        run: cd android && ./gradlew bundleRelease
        env:
          SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}

      # Google Cloud ì¸ì¦
      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.PLAY_STORE_JSON_KEY }}'

      # Play Store APIìš© Access Token ë°œê¸‰
      - name: Generate Access Token for Play Store API
        id: generate_token
        run: |
          # scopeê°€ ì ìš©ëœ í† í°ì„ ë°œê¸‰ë°›ì•„, ë‹¤ìŒ ìŠ¤í…ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ outputìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
          echo "access_token=$(gcloud auth print-access-token --scopes='https://www.googleapis.com/auth/androidpublisher')" >> $GITHUB_OUTPUT

      # Play Storeì— AAB ì—…ë¡œë“œ ë° ì¶œì‹œ (API ì§ì ‘ í˜¸ì¶œ)
      - name: Upload and Release to Play Store
        run: |
          set -euo pipefail
          
           # ë³€ìˆ˜ ì„¤ì •
           PACKAGE_NAME="${{ secrets.ANDROID_PACKAGE_NAME }}"
           AAB_PATH="android/app/build/outputs/bundle/release/app-release.aab"
           TRACK="internal"
          
           # ì¸ì¦ëœ ì•¡ì„¸ìŠ¤ í† í° ê°€ì ¸ì˜¤ê¸° (ì°¸ì¡° ë°©ì‹ ë³€ê²½)
           ACCESS_TOKEN="${{ steps.generate_token.outputs.access_token }}"

          if [[ ! -f "$AAB_PATH" ]]; then
            echo "AAB not found at $AAB_PATH"; exit 1
          fi

          # 1. í¸ì§‘ ì„¸ì…˜ ì‹œì‘ ë° editId íšë“
          echo "1. Creating a new edit session..."
          EDIT_RESPONSE=$(curl -fSs -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits")
          EDIT_ID=$(echo $EDIT_RESPONSE | jq -r .id)
          if [[ -z "$EDIT_ID" || "$EDIT_ID" == "null" ]]; then
            echo "Failed to create edit: $EDIT_RESPONSE"; exit 1; fi
          echo "   - Success! Edit ID: $EDIT_ID"

          # 2. AAB ì—…ë¡œë“œ ë° versionCode íšë“
          echo "2. Uploading AAB..."
          UPLOAD_RESPONSE=$(curl -fSs -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --data-binary "@$AAB_PATH" \
            "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits/$EDIT_ID/bundles?uploadType=media")
          VERSION_CODE=$(echo $UPLOAD_RESPONSE | jq -r .versionCode)
          if [[ -z "$VERSION_CODE" || "$VERSION_CODE" == "null" ]]; then
            echo "Failed to upload bundle: $UPLOAD_RESPONSE"; exit 1; fi
          echo "   - Success! Version Code: $VERSION_CODE"

          # 3. íŠ¸ë™ ì—…ë°ì´íŠ¸ (â­ inAppUpdatePriority ì„¤ì •)
          echo "3. Assigning build to the '$TRACK' track..."
          TRACK_RESPONSE=$(curl -fSs -X PUT \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
                  "releases": [{
                    "versionCodes": ["'"$VERSION_CODE"'"],
                    "status": "draft",
                    "inAppUpdatePriority": ${{ github.event.inputs.updatePriority }}
                  }]
                }' \
            "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits/$EDIT_ID/tracks/$TRACK")
          echo "   - Success! Track updated."

          # 4. ëª¨ë“  ë³€ê²½ì‚¬í•­ ì ìš©(Commit)
          echo "4. Committing all changes..."
          COMMIT_RESPONSE=$(curl -fSs -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits/$EDIT_ID:commit")
          echo "   - ğŸ‰ Deploy complete!"