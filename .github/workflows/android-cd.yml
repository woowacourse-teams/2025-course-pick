name: Android CD (Deploy to PlayStore directly)

on:
  # Github Action íƒ­ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      updatePriority:
        description: 'ì—…ë°ì´íŠ¸ ìš°ì„ ìˆœìœ„ (1-5). 5ëŠ” ì¦‰ì‹œ ì—…ë°ì´íŠ¸.'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Jobì— ê¶Œí•œì„ ë¶€ì—¬í•˜ì—¬ Google Cloud ì¸ì¦ í† í°ì„ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      # 1. ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. JDK 21 ì„¤ì •
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # 3. Gradle ìºì‹œ ì„¤ì •
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      # 4. google-services.json íŒŒì¼ ë””ì½”ë”©
      - name: Decode google-services.json
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 -d > android/app/google-services.json

      # 5. Keystore íŒŒì¼ ë””ì½”ë”©
      - name: Decode Keystore
        run: echo "${{ secrets.SIGNING_KEYSTORE_BASE64 }}" | base64 -d > android/app/keystore.jks

      # 6. Release AAB ë¹Œë“œ
      - name: Build Release AAB
        run: cd android && ./gradlew bundleRelease
        env:
          SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}

      # 7. Google Cloud ì¸ì¦ (ì•¡ì„¸ìŠ¤ í† í° íšë“)
      - name: Authenticate with Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.PLAY_STORE_JSON_KEY }}'

      # 8. Play Storeì— AAB ì—…ë¡œë“œ ë° ì¶œì‹œ (API ì§ì ‘ í˜¸ì¶œ)
      - name: Upload and Release to Play Store
        run: |
          set -e # ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨

          # ë³€ìˆ˜ ì„¤ì •
          PACKAGE_NAME="${{ secrets.ANDROID_PACKAGE_NAME }}"
          AAB_PATH="android/app/build/outputs/bundle/release/app-release.aab"
          TRACK="internal" # ë°°í¬í•  íŠ¸ë™: internal, alpha, beta, production
          
          # ì¸ì¦ëœ ì•¡ì„¸ìŠ¤ í† í° ê°€ì ¸ì˜¤ê¸°
          ACCESS_TOKEN="${{ steps.auth.outputs.access_token }}"
          
          # 1. í¸ì§‘ ì„¸ì…˜ ì‹œì‘ ë° editId íšë“
          echo "1. Creating a new edit session..."
          EDIT_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits")
          EDIT_ID=$(echo $EDIT_RESPONSE | jq -r .id)
          echo "   - Success! Edit ID: $EDIT_ID"
          
          # 2. AAB ì—…ë¡œë“œ ë° versionCode íšë“
          echo "2. Uploading AAB..."
          UPLOAD_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --data-binary "@$AAB_PATH" \
            "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits/$EDIT_ID/bundles")
          VERSION_CODE=$(echo $UPLOAD_RESPONSE | jq -r .versionCode)
          echo "   - Success! Version Code: $VERSION_CODE"
          
          # 3. íŠ¸ë™ ì—…ë°ì´íŠ¸ (â­ inAppUpdatePriority ì„¤ì •)
          echo "3. Assigning build to the '$TRACK' track with high priority..."
          curl -s -X PUT \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
                  "releases": [{
                    "versionCodes": ["'"$VERSION_CODE"'"],
                    "status": "draft",
                    "inAppUpdatePriority": ${{ github.event.inputs.updatePriority }}
                  }]
                }' \
            "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits/$EDIT_ID/tracks/$TRACK"
          echo "   - Success!"
          
          # 4. ëª¨ë“  ë³€ê²½ì‚¬í•­ ì ìš©(Commit)
          echo "4. Committing all changes..."
          curl -s -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            "https://androidpublisher.googleapis.com/androidpublisher/v3/applications/$PACKAGE_NAME/edits/$EDIT_ID:commit"
          echo "   - ğŸ‰ Deploy complete!"