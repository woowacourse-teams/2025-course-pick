name: Discord Alert

on:
  pull_request:
    types: [ review_requested ]
  pull_request_review:
    types: [ submitted ]

jobs:
  notify:
    name: ì•Œë¦¼ë³´ë‚´ê¸°
    runs-on: ubuntu-latest
    steps:
      - name: GitHub IDì™€ Discord ID ë§¤í•‘
        id: mapper
        shell: bash
        env:
          ID_MAP: ${{ secrets.DISCORD_ID_MAP }}
        run: |
          # 1. ì´ë²¤íŠ¸ì— ë”°ë¥¸ ì•Œë¦¼ ëŒ€ìƒì ê²°ì •
          if [[ "${{ github.event.action }}" == "review_requested" ]]; then
            TARGET_GITHUB_ID="${{ github.event.requested_reviewer.login }}"
          else
            TARGET_GITHUB_ID="${{ github.event.pull_request.user.login }}"
          fi
          
          # 2. ì•¡ì…˜ì„ ìˆ˜í–‰í•œ ì‚¬ëŒ(ë°œì‹ ì) í™•ì¸
          SENDER_GITHUB_ID="${{ github.event.sender.login }}"
          
          # 3. ë³¸ì¸ì´ ë³¸ì¸ì—ê²Œ ì•Œë¦¼ì„ ë³´ë‚´ëŠ” ìƒí™©ì¸ì§€ ì²´í¬
          if [[ "$TARGET_GITHUB_ID" == "$SENDER_GITHUB_ID" ]]; then
            echo "SHOULD_NOTIFY=false" >> $GITHUB_ENV
          else
            echo "SHOULD_NOTIFY=true" >> $GITHUB_ENV
          fi
          
          # 4. Discord ID ë§¤í•‘
          DISCORD_ID=$(echo "$ID_MAP" | jq -r --arg key "$TARGET_GITHUB_ID" '.[$key] // $key')
          echo "MENTION_TARGET=$DISCORD_ID" >> $GITHUB_ENV

      - name: ë¦¬ë·° ìš”ì²­ ì•Œë¦¼
        if: env.SHOULD_NOTIFY == 'true' && github.event.action == 'review_requested'
        uses: Ilshidur/action-discord@0.4.0
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            ğŸ™‡â€â™‚ï¸ **ë¦¬ë·° ìš”ì²­**
            ğŸ¯ {{ EVENT_PAYLOAD.sender.login }} â†’ ${{ env.MENTION_TARGET }}
            ğŸ”— [{{ EVENT_PAYLOAD.pull_request.title }}](<{{ EVENT_PAYLOAD.pull_request.html_url }}>)
            â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•

      - name: ë¦¬ë·° ì™„ë£Œ ì•Œë¦¼
        if: env.SHOULD_NOTIFY == 'true' && github.event_name == 'pull_request_review'
        uses: Ilshidur/action-discord@0.4.0
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            âœ… **ë¦¬ë·° ë“±ë¡**
            ğŸ¯ {{ EVENT_PAYLOAD.sender.login }} â†’ ${{ env.MENTION_TARGET }}
            ğŸ”— [{{ EVENT_PAYLOAD.pull_request.title }}](<{{ EVENT_PAYLOAD.review.html_url }}>)
            â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•
