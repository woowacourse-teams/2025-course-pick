name: Backend Dev Server CD

on:
  pull_request:
    branches: [ backend ]
  workflow_dispatch:

jobs:
  ci:
    name: CI ì‹¤í–‰
    uses: ./.github/workflows/backend-ci.yml
    secrets: inherit

  build:
    name: ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
    needs: ci
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: ë ˆí¬ì§€í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: JDK 21 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: 'gradle'

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: í”„ë¡œì íŠ¸ gradlew ë¹Œë“œ
        run: ./gradlew clean build -x test

      - name: Docker ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        run: |
          docker buildx build \
            --platform=linux/arm64 \
            -t ${{ secrets.DOCKER_USERNAME }}/coursepick-backend:dev \
            --push \
            .

  deploy:
    name: ê°œë°œì„œë²„ ë°°í¬
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: SSHë¡œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/coursepick
            
            echo "ðŸš€ ê°œë°œ ì„œë²„ ë°°í¬ ì‹œìž‘..."
            
            echo "ðŸ“¦ ìµœì‹  ì´ë¯¸ì§€ Pull..."
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/coursepick-backend:dev
            
            echo "ðŸŒ³ .env íŒŒì¼ ìƒì„±..."
            cat > .env <<'EOF'
            ${{ secrets.DEV_ENV_FILE }}
            EOF
            chmod 600 .env
            
            echo "â–¶ï¸ ìƒˆ ì„œë²„ ì‹œìž‘..."
            sudo docker compose --env-file .env up -d --pull always backend
            
            echo "ðŸ§¹ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬..."
            sudo docker image prune -a -f
            
            echo "â›‘ï¸ í—¬ìŠ¤ ì²´í¬..."
            for i in $(seq 1 10); do
              SERVER_STATUS=$(curl -o /dev/null -w "%{http_code}" http://localhost:80/actuator/health || echo "000")
              if [ "$SERVER_STATUS" -eq 200 ]; then
                echo "âœ… ë°°í¬ ì„±ê³µ! ì„œë²„ ë™ìž‘ ì¤‘..."
                exit 0
              else
                echo "Attempt $i/10: í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ (status=$SERVER_STATUS). 5ì´ˆ í›„ ìž¬ì‹œë„..."
                sleep 5
              fi
            done
            
            echo "âŒ ë°°í¬ ì‹¤íŒ¨! ì„œë²„ê°€ ë™ìž‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            sudo docker logs coursepick-backend --tail 50
            exit 1
